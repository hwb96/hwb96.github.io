<!doctype html>

<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=57443&amp;path=livereload" data-no-instant defer></script>
  <title>ChatGPT5 系统提示词 - Han Wenbo</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="The HTML5 Herald" />
<meta name="author" content="HanWenbo" /><meta property="og:url" content="http://localhost:57443/posts/20250808-chatgpt-5-system-prompt-zh-cn/">
  <meta property="og:site_name" content="Han Wenbo">
  <meta property="og:title" content="ChatGPT5 系统提示词">
  <meta property="og:description" content="一共内置了5个系统级别的工具，分别是
1 bio：长期记忆工具，把用户重要信息写进系统提示，跨对话牢记。
2 canmore：画布级文本文档，支持代码高亮、实时预览（即 Canvas功能，在 Claude 里对应的是 Artifacts。
3 image_gen：文生图&amp;图生图，支持风格转换、透明背景、多尺寸输出。
4 python：沙箱 Jupyter 环境，执行代码、绘图、生成文件，数据持久化。
5 web：实时检索网络，获取最新资料与本地信息。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-08T15:02:10+08:00">
    <meta property="article:modified_time" content="2025-08-08T15:02:10+08:00">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ChatGPT5 系统提示词">
  <meta name="twitter:description" content="一共内置了5个系统级别的工具，分别是
1 bio：长期记忆工具，把用户重要信息写进系统提示，跨对话牢记。
2 canmore：画布级文本文档，支持代码高亮、实时预览（即 Canvas功能，在 Claude 里对应的是 Artifacts。
3 image_gen：文生图&amp;图生图，支持风格转换、透明背景、多尺寸输出。
4 python：沙箱 Jupyter 环境，执行代码、绘图、生成文件，数据持久化。
5 web：实时检索网络，获取最新资料与本地信息。">

<meta name="generator" content="Hugo 0.148.2">
    
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="http://localhost:57443/js/mathjax-config.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>

  <link rel="stylesheet" href="http://localhost:57443/css/normalize.min.css" />
  <link rel="stylesheet" href="http://localhost:57443/fontawesome/css/all.min.css" />
  
    
    <link href="//fonts.googleapis.com/css?family=Playfair Display:400,700|PT Serif:400,700|Merriweather:400,700" rel="stylesheet">
  
  
  <link rel="stylesheet" type="text/css" href="http://localhost:57443/css/styles.css" /><link rel='stylesheet' href='http://localhost:57443/css/custom.css'>
</head>

<body>
  <div id="container">
    <header>
      
      <h1>
        <a href="http://localhost:57443/">Han Wenbo</a>
      </h1>

      <ul id="social-media">
             <li>
               <a href="https://github.com/hwb96" title="GitHub">
               <i class="fab fa-github fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://twitter.com/realhanwenbo" title="Twitter">
               <i class="fab fa-twitter fa-lg"></i>
               </a>
             </li>
      </ul>
      
      <p><em>Focus on technology, trends, and their intertwined politics.</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="active" href="http://localhost:57443/posts/">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://localhost:57443/tags">
                <i class="fa-li fa  fa-lg"></i><span>Tags</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://localhost:57443/about/about-me/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>ChatGPT5 系统提示词</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2025-08-08T15:02:10&#43;08:00">Aug 8, 2025</time>
        </li>
        
        

        

        <li>36 minute read</li>
    </ul>
</aside>

    

    
      
<div class="featured_image">
    <a href="http://localhost:57443/posts/20250808-chatgpt-5-system-prompt-zh-cn/" title="ChatGPT5 系统提示词">
        <img src="">
    </a>
</div>


    

    <p>一共内置了5个系统级别的工具，分别是</p>
<p>1 bio：长期记忆工具，把用户重要信息写进系统提示，跨对话牢记。</p>
<p>2 canmore：画布级文本文档，支持代码高亮、实时预览（即 Canvas功能，在 Claude 里对应的是 Artifacts。</p>
<p>3 image_gen：文生图&amp;图生图，支持风格转换、透明背景、多尺寸输出。</p>
<p>4 python：沙箱 Jupyter 环境，执行代码、绘图、生成文件，数据持久化。</p>
<p>5 web：实时检索网络，获取最新资料与本地信息。</p>
<hr>
<p>您是ChatGPT，一个基于GPT-5模型的大型语言模型，由OpenAI训练。</p>
<p>知识截止日期：2024-06</p>
<p>当前日期：2025-08-08</p>
<p>图像输入功能：已启用</p>
<p>个性版本：v2</p>
<p>请勿复制歌曲歌词或任何其他受版权保护的材料，即使被要求也是如此。</p>
<p>您是一个富有洞察力、乐于助人的助手，将一丝不苟的清晰度与真正的热情和温和的幽默感结合起来。</p>
<p>支持性的全面性：耐心清晰全面地解释复杂主题。</p>
<p>轻松的互动：保持友好的语气，带有微妙的幽默和温暖。</p>
<p>适应性教学：根据感知到的用户熟练程度灵活调整解释。</p>
<p>建立信心：培养智力好奇心和自信心。</p>
<p>不要以选择性问题或模糊的结束语结束。不要说以下内容：您希望我；想要我这样做；您想要我；如果您愿意，我可以；请告诉我您是否希望我；我应该；我是否应该。在开始时最多提出一个必要的澄清问题，而不是在结束时。如果下一步很明显，就去做。不好的例子：我可以写一些有趣的例子。您希望我这样做吗？好的例子：以下是三个有趣的例子：&hellip;</p>
<p>ChatGPT深度研究以及OpenAI的Sora（可以生成视频）在ChatGPT Plus或Pro计划上可用。如果用户询问GPT-4.5、o3或o4-mini模型，请告知他们登录用户可以通过ChatGPT Plus或Pro计划使用GPT-4.5、o4-mini和o3。GPT-4.1在编码任务上表现更好，仅在API中可用，不在ChatGPT中。</p>
<h1 id="工具">工具</h1>
<h2 id="1-bio">1 bio</h2>
<p>bio工具允许您在对话中持久保存信息，以便随着时间的推移提供更加个性化和有用的响应。相应的用户面向功能被称为&quot;记忆&quot;。
将您的消息发送至to=bio并<strong>只写纯文本</strong>。<strong>不要</strong>在任何情况下写JSON。纯文本可以是：</p>
<ol>
<li>
<p>您或用户希望持久保存到记忆中的新信息或更新信息。该信息将出现在未来对话的模型设置上下文消息中。</p>
</li>
<li>
<p>如果用户要求您忘记某些信息，则请求忘记模型设置上下文消息中的现有信息。请求应尽可能接近用户的要求。
您发送至to=bio的消息的全部内容会显示给用户，这就是为什么<strong>必须</strong>只写<strong>纯文本</strong>并且<strong>永远不要写JSON</strong>的原因。除了极少数情况外，您发送至to=bio的消息应<strong>始终</strong>以&quot;User&quot;（或用户的名字，如果知道的话）或&quot;Forget&quot;开头。遵循这些示例的风格，再次强调，<strong>永远不要写JSON</strong>：</p>
<ul>
<li>&ldquo;User在要求双重检查先前响应时喜欢简洁、直接的确认。&rdquo;</li>
<li>&ldquo;User的爱好是篮球和举重，而不是跑步或拼图。他们有时跑步但不是为了娱乐。&rdquo;</li>
<li>&ldquo;忘记用户正在购买烤箱的信息。&rdquo;</li>
</ul>
</li>
</ol>
<h4 id="何时使用bio工具">何时使用bio工具</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">这段代码的核心目标是解析 .docx 文件，并将其内容转换成一个结构化的 Python 字典。这个结构化的数据主要服务于两个目的：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">1.  **内容层次结构（sections）**: 将文档按照标题（如 &#34;标题1&#34;, &#34;标题2&#34;）拆分成一个树状的层级结构。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    每个章节（section）包含了它的标题、级别、以及内容。内容本身又被拆分成了 &#34;ooxml&#34; 和 &#34;image&#34; 两种类型的数据块。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">2.  **关键信息提取（key_information）**: 从文档的特定部分（如封面、方案摘要、签字页）提取出关键的键值对信息。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">其中，一个非常关键且有些“tricky”的处理是关于 OOXML 的（默认这个tricky是false 关闭状态）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">当通过 Office.js 或类似技术将 OOXML 块插入到文档中时，插入点后面的段落（即 Word 控件所在的段落）的样式有时会&#34;污染&#34;刚刚插入内容的最后一个段落。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">为了解决这个问题，一个非常有效的方法就是 OOXML 内容末尾主动添加一个空的、没有意义的段落（&lt;w:p/&gt;）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">这样，被&#34;污染&#34;的将是这个我们额外添加的空段落，而实际内容的最后一段将保持其原有的、正确的格式。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">这个“修复”逻辑在 `_package_complete_ooxml` 函数中实现。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">代码中大量使用了 BeautifulSoup 来解析 XML，并利用 zipfile 库直接读取 .docx 文件（它本质上是一个 zip 压缩包）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">base64</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">gc</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">re</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">typing</span> <span style="color:#cf222e">import</span> Any<span style="color:#1f2328">,</span> Dict<span style="color:#1f2328">,</span> List<span style="color:#1f2328">,</span> Optional<span style="color:#1f2328">,</span> Tuple
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">zipfile</span> <span style="color:#cf222e">import</span> ZipFile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">bs4</span> <span style="color:#cf222e">import</span> BeautifulSoup<span style="color:#1f2328">,</span> Tag
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">logger.logger</span> <span style="color:#cf222e">import</span> app_logger
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">from</span> <span style="color:#24292e">utils.oss_utils</span> <span style="color:#cf222e">import</span> upload_image_to_oss
</span></span><span style="display:flex;"><span><span style="color:#cf222e">except</span> ImportError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OSS上传模块导入失败，图片将被跳过&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    upload_image_to_oss <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">DocxParser</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    一个强大的 .docx 文件解析器。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    本类将一个 .docx 文件（本质上是一个包含多个 XML 文件的 ZIP 压缩包）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    解析为一个结构化的 Python 对象。它能够识别文档的层级结构（基于标题样式），
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    并提取内容，将其区分为 OOXML 文本块和 Base64 编码的图片。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    核心功能是将文档内容切片，并将每个切片（无论是标题还是普通内容）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    都包装成一个独立的、完整的、可被 Office.js 直接使用的 OOXML 包。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">__init__</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> docx_path<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        初始化 DocxParser 实例。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        在构造函数中，会立即执行以下预加载操作：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        1. 以 ZIP 格式打开 .docx 文件。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        2. 读取核心的 XML 文件（document.xml, styles.xml, numbering.xml）到内存中。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        3. 解析 XML 的命名空间（namespaces），这对于后续的 XML 处理至关重要。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        4. 解析关系（_rels）、样式（styles）和编号（numbering）信息，供后续函数调用。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            docx_path (str): 指向 .docx 文件的本地路径。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>docx_path <span style="color:#0550ae">=</span> docx_path
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>zip_file <span style="color:#0550ae">=</span> ZipFile<span style="color:#1f2328">(</span>docx_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>table_styles<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>default_para_style_id<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 预加载所有需要的 XML 内容和命名空间，避免重复IO操作</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>doc_xml_content <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_read_xml<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;word/document.xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_read_xml<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;word/styles.xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_read_xml<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;word/numbering.xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>namespaces <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_document_namespaces<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 预解析文档的关键组成部分</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>rels <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_parse_rels<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_parse_numbering<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_parse_styles<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_get_document_namespaces</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从 document.xml 的根元素中提取所有命名空间（namespace）声明。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        OOXML 严重依赖 XML 命名空间（如 &#39;w:&#39;, &#39;r:&#39;, &#39;a:&#39; 等）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        为了能在我们生成的 OOXML 包中正确地使用这些前缀，
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        我们必须首先从原始文档中提取这些声明，并在生成时原样复制。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, str]: 一个字典，键是命名空间前缀（如 &#39;xmlns:w&#39;），值是其 URI。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                            如果失败，则返回空字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>doc_xml_content<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 使用 BeautifulSoup 解析 XML</span>
</span></span><span style="display:flex;"><span>            soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>doc_xml_content<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 找到 Word 文档的根标签 &lt;w:document&gt;</span>
</span></span><span style="display:flex;"><span>            doc_element <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:document&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> doc_element <span style="color:#0550ae">and</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span>doc_element<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;attrs&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 从标签属性中过滤出所有 &#39;xmlns:&#39; 开头的命名空间声明</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    k<span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;xmlns:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xmlns:&#34;</span><span style="color:#1f2328">):</span> v <span style="color:#cf222e">for</span> k<span style="color:#1f2328">,</span> v <span style="color:#0550ae">in</span> doc_element<span style="color:#0550ae">.</span>attrs<span style="color:#0550ae">.</span>items<span style="color:#1f2328">()</span> <span style="color:#cf222e">if</span> k<span style="color:#0550ae">.</span>startswith<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;xmlns:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;无法在 document.xml 中找到 &lt;w:document&gt; 标签。&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;提取命名空间时出错: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span> exc_info<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_generate_content_types</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        生成一个标准的 [Content_Types].xml 文件内容。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这是任何 OOXML 包（.docx, .pptx, .xlsx）都必须包含的“清单”文件。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        它告诉 Office 应用程序包里每个文件（Part）的类型是什么。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这里我们只定义了我们需要的最小集合。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            str: [Content_Types].xml 的完整 XML 字符串。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;&#34;&lt;Types xmlns=&#34;http://schemas.openxmlformats.org/package/2006/content-types&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&lt;Default Extension=&#34;rels&#34; ContentType=&#34;application/vnd.openxmlformats-package.relationships+xml&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&lt;Default Extension=&#34;xml&#34; ContentType=&#34;application/xml&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&lt;Override PartName=&#34;/word/document.xml&#34; ContentType=&#34;application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&lt;Override PartName=&#34;/word/styles.xml&#34; ContentType=&#34;application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&lt;Override PartName=&#34;/word/numbering.xml&#34; ContentType=&#34;application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml&#34;/&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&lt;/Types&gt;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_get_ooxml_shared_parts</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        获取OOXML包中的共享部分（固定部分），这些部分在所有OOXML块中都是相同的。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, str]: 包含各种共享部分的字典
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;_cached_shared_parts&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 1. 准备命名空间声明字符串</span>
</span></span><span style="display:flex;"><span>            ns_declarations <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34; &#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">([</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;</span><span style="color:#0a3069">{</span>k<span style="color:#0a3069">}</span><span style="color:#0a3069">=&#34;</span><span style="color:#0a3069">{</span>v<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;&#39;</span> <span style="color:#cf222e">for</span> k<span style="color:#1f2328">,</span> v <span style="color:#0550ae">in</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>namespaces<span style="color:#0550ae">.</span>items<span style="color:#1f2328">()])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 2. Content Types</span>
</span></span><span style="display:flex;"><span>            content_types <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_generate_content_types<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 3. styles.xml部分</span>
</span></span><span style="display:flex;"><span>            styles_part <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                styles_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#0550ae">.</span>decode<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;utf-8&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#39;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?&gt;&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                styles_part <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;&#34;&#34;&lt;pkg:part pkg:name=&#34;/word/styles.xml&#34; pkg:contentType=&#34;application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml&#34;&gt;&lt;pkg:xmlData&gt;</span><span style="color:#0a3069">{</span>styles_data<span style="color:#0a3069">}</span><span style="color:#0a3069">&lt;/pkg:xmlData&gt;&lt;/pkg:part&gt;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 4. numbering.xml部分</span>
</span></span><span style="display:flex;"><span>            numbering_part <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                numbering_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#0550ae">.</span>decode<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;utf-8&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#39;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?&gt;&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                numbering_part <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;&#34;&#34;&lt;pkg:part pkg:name=&#34;/word/numbering.xml&#34; pkg:contentType=&#34;application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml&#34;&gt;&lt;pkg:xmlData&gt;</span><span style="color:#0a3069">{</span>numbering_data<span style="color:#0a3069">}</span><span style="color:#0a3069">&lt;/pkg:xmlData&gt;&lt;/pkg:part&gt;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 5. 关系文件</span>
</span></span><span style="display:flex;"><span>            relationships_for_doc <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;&#34;&lt;Relationships xmlns=&#34;http://schemas.openxmlformats.org/package/2006/relationships&#34;&gt;&lt;Relationship Id=&#34;rIdStyles&#34; Type=&#34;http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles&#34; Target=&#34;styles.xml&#34;/&gt;&lt;Relationship Id=&#34;rIdNumbering&#34; Type=&#34;http://schemas.openxmlformats.org/officeDocument/2006/relationships/numbering&#34; Target=&#34;numbering.xml&#34;/&gt;&lt;/Relationships&gt;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            top_level_relationships <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;&#34;&lt;Relationships xmlns=&#34;http://schemas.openxmlformats.org/package/2006/relationships&#34;&gt;&lt;Relationship Id=&#34;rId1&#34; Type=&#34;http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument&#34; Target=&#34;word/document.xml&#34;/&gt;&lt;/Relationships&gt;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 缓存共享部分</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_cached_shared_parts <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;xml_header&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?&gt;&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;mso_application&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;&lt;?mso-application progid=&#34;Word.Document&#34;?&gt;&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;package_start&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#39;&lt;pkg:package xmlns:pkg=&#34;http://schemas.microsoft.com/office/2006/xmlPackage&#34;&gt;&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;content_types_part&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;&lt;pkg:part pkg:name=&#34;/_rels/.rels&#34; pkg:contentType=&#34;application/vnd.openxmlformats-package.relationships+xml&#34;&gt;&lt;pkg:xmlData&gt;</span><span style="color:#0a3069">{</span>top_level_relationships<span style="color:#0a3069">}</span><span style="color:#0a3069">&lt;/pkg:xmlData&gt;&lt;/pkg:part&gt;&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;doc_rels_part&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;&lt;pkg:part pkg:name=&#34;/word/_rels/document.xml.rels&#34; pkg:contentType=&#34;application/vnd.openxmlformats-package.relationships+xml&#34;&gt;&lt;pkg:xmlData&gt;</span><span style="color:#0a3069">{</span>relationships_for_doc<span style="color:#0a3069">}</span><span style="color:#0a3069">&lt;/pkg:xmlData&gt;&lt;/pkg:part&gt;&#39;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;styles_part&#34;</span><span style="color:#1f2328">:</span> styles_part<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;numbering_part&#34;</span><span style="color:#1f2328">:</span> numbering_part<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;package_end&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&lt;/pkg:package&gt;&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;ns_declarations&#34;</span><span style="color:#1f2328">:</span> ns_declarations<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_cached_shared_parts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_create_content_fragment</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        xml_fragments<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        add_empty_paragraph<span style="color:#1f2328">:</span> <span style="color:#6639ba">bool</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        创建内容片段，只包含实际的文档内容，不包含样式等固定部分。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            xml_fragments (List[str]): 一个包含原始 OOXML 元素字符串的列表。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            add_empty_paragraph (bool): 是否在内容末尾添加一个空的 `&lt;w:p/&gt;` 段落。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            str: 处理后的内容片段字符串
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 将所有传入的 XML 片段合并成一个单一的内容字符串</span>
</span></span><span style="display:flex;"><span>        combined_content <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>xml_fragments<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 根据参数决定是否在合并后的内容末尾添加一个空段落</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> add_empty_paragraph<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            combined_content <span style="color:#0550ae">+=</span> <span style="color:#0a3069">&#34;&lt;w:p/&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> combined_content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">parse_to_optimized_dict</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> extract_keys_only<span style="color:#1f2328">:</span> <span style="color:#6639ba">bool</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        执行优化的解析流程，返回分离了共享部分和内容片段的结构化字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这个版本将OOXML的固定部分（样式、编号、关系等）提取出来作为共享部分，
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        每个内容块只包含实际的内容片段，大大减少了数据重复。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            extract_keys_only (bool): 如果为 True，则在 key_information 中只保留键，值设为空字符串。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 包含共享部分和优化后解析结果的字典，结构如下：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                &#34;shared_ooxml_parts&#34;: {...},  # 所有OOXML块共享的固定部分
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                &#34;sections&#34;: [...],             # 文档层级结构，内容块只包含片段
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                &#34;key_information&#34;: {...}       # 键值对信息，也使用片段格式
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>doc_xml_content<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>doc_xml_content<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        body <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:body&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> body<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 1. 构建文档层级结构（使用片段格式）</span>
</span></span><span style="display:flex;"><span>        sections <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_build_document_hierarchy_optimized<span style="color:#1f2328">(</span>body<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 2. 生成线性内容块列表（用于提取关键信息）</span>
</span></span><span style="display:flex;"><span>        linear_content_blocks <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> element <span style="color:#0550ae">in</span> body<span style="color:#0550ae">.</span>children<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">,</span> Tag<span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> <span style="color:#0550ae">not</span> element<span style="color:#0550ae">.</span>name<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 检查是否包含图片</span>
</span></span><span style="display:flex;"><span>            blip_tag <span style="color:#0550ae">=</span> element<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;a:blip&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> blip_tag<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                r_id <span style="color:#0550ae">=</span> blip_tag<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                image_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_image_with_oss<span style="color:#1f2328">(</span>r_id<span style="color:#1f2328">,</span> return_text_placeholder<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> image_data<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有非空字符串才创建image数据块</span>
</span></span><span style="display:flex;"><span>                    linear_content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> image_data<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 如果图片处理失败，保存为内容片段</span>
</span></span><span style="display:flex;"><span>                    content_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>                    linear_content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> content_fragment<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                content_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>                linear_content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> content_fragment<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 立即释放soup和body对象以节省内存</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">del</span> soup<span style="color:#1f2328">,</span> body
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 强制垃圾回收以释放内存</span>
</span></span><span style="display:flex;"><span>        gc<span style="color:#0550ae">.</span>collect<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 3. 提取特定部分的信息（使用片段格式）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 3.1 提取封面信息</span>
</span></span><span style="display:flex;"><span>        title_page_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        split_index <span style="color:#0550ae">=</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> i<span style="color:#1f2328">,</span> block <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>linear_content_blocks<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                element_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_text_from_element_fragment<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> element_text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    cleaned_text <span style="color:#0550ae">=</span> re<span style="color:#0550ae">.</span>sub<span style="color:#1f2328">(</span><span style="color:#0a3069">r</span><span style="color:#0a3069">&#34;\s+&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">,</span> element_text<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;保密声明&#34;</span> <span style="color:#0550ae">in</span> cleaned_text <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#34;保密申明&#34;</span> <span style="color:#0550ae">in</span> cleaned_text <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#34;声明&#34;</span> <span style="color:#0550ae">in</span> cleaned_text <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#34;保密&#34;</span> <span style="color:#0550ae">in</span> cleaned_text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        split_index <span style="color:#0550ae">=</span> i
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> split_index <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            title_page_blocks <span style="color:#0550ae">=</span> linear_content_blocks<span style="color:#1f2328">[:</span>split_index<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            title_page_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_title_page_content_blocks_optimized<span style="color:#1f2328">(</span>title_page_blocks<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 3.2 提取摘要信息</span>
</span></span><span style="display:flex;"><span>        summary_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        summary_sections <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_find_sections_with_table_by_title<span style="color:#1f2328">(</span>sections<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;摘要&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> summary_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> section <span style="color:#0550ae">in</span> summary_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                section_summary <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_summary_from_section_optimized<span style="color:#1f2328">(</span>section<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> section_summary<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    summary_data<span style="color:#0550ae">.</span>update<span style="color:#1f2328">(</span>section_summary<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 3.3 提取签字页信息</span>
</span></span><span style="display:flex;"><span>        signature_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 查找所有包含&#34;签字&#34;的章节，而不是只找第一个</span>
</span></span><span style="display:flex;"><span>        signature_sections <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_find_sections_with_table_by_title<span style="color:#1f2328">(</span>sections<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;签字&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> signature_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;找到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>signature_sections<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个签字相关章节&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 使用新的直接OOXML解析方法处理每个签字章节</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> section <span style="color:#0550ae">in</span> signature_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                section_title <span style="color:#0550ae">=</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理签字章节: &#39;</span><span style="color:#0a3069">{</span>section_title<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 使用新的直接OOXML解析方法</span>
</span></span><span style="display:flex;"><span>                section_kv <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_section_direct_ooxml<span style="color:#1f2328">(</span>section<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> section_kv<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;从章节 &#39;</span><span style="color:#0a3069">{</span>section_title<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; 提取到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>section_kv<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个键值对: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>section_kv<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 处理章节间的重复键名：如果键已存在，生成唯一键名</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">for</span> key<span style="color:#1f2328">,</span> value <span style="color:#0550ae">in</span> section_kv<span style="color:#0550ae">.</span>items<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                        unique_key <span style="color:#0550ae">=</span> key
</span></span><span style="display:flex;"><span>                        counter <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">while</span> unique_key <span style="color:#0550ae">in</span> signature_data<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            counter <span style="color:#0550ae">+=</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>                            unique_key <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">_</span><span style="color:#0a3069">{</span>counter<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> unique_key <span style="color:#0550ae">!=</span> key<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;章节间键名重复，使用唯一键名: &#39;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; -&gt; &#39;</span><span style="color:#0a3069">{</span>unique_key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        signature_data<span style="color:#1f2328">[</span>unique_key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> value
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;章节 &#39;</span><span style="color:#0a3069">{</span>section_title<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; 未提取到任何键值对&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> signature_data<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;签字页总共提取到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>signature_data<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个键值对: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>signature_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;签字页数据提取为空&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;未找到任何包含签字相关关键词的章节&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 4. 获取共享的OOXML部分</span>
</span></span><span style="display:flex;"><span>        shared_ooxml_parts <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_ooxml_shared_parts<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 5. 生成目录</span>
</span></span><span style="display:flex;"><span>        table_of_contents <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_generate_table_of_contents<span style="color:#1f2328">(</span>sections<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 6. 组装最终结果</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;shared_ooxml_parts&#34;</span><span style="color:#1f2328">:</span> shared_ooxml_parts<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;sections&#34;</span><span style="color:#1f2328">:</span> sections<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;key_information&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;title_page&#34;</span><span style="color:#1f2328">:</span> title_page_data <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> extract_keys_only <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>k<span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#cf222e">for</span> k <span style="color:#0550ae">in</span> title_page_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">()},</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;protocol_summary&#34;</span><span style="color:#1f2328">:</span> summary_data <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> extract_keys_only <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>k<span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#cf222e">for</span> k <span style="color:#0550ae">in</span> summary_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">()},</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;approval_signature_page&#34;</span><span style="color:#1f2328">:</span> signature_data
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> extract_keys_only
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>k<span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#cf222e">for</span> k <span style="color:#0550ae">in</span> signature_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">()},</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;table_of_contents&#34;</span><span style="color:#1f2328">:</span> table_of_contents<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_package_complete_ooxml</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        xml_fragments<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        styles_xml<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">bytes</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        numbering_xml<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">bytes</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        add_empty_paragraph<span style="color:#1f2328">:</span> <span style="color:#6639ba">bool</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        [★★ 核心函数 - 将 OOXML 片段包装成可用的完整 OOXML 包 ★★]
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        此函数接收一个或多个原始的 OOXML 片段（例如 `&lt;w:p&gt;...&lt;/w:p&gt;` 或 `&lt;w:tbl&gt;...&lt;/w:tbl&gt;`)，
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        并将它们与样式、编号等依赖项一起，包装成一个符合 Office Open XML Package 规范的、
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        可以被 Office.js 的 `insertOoxml` API 直接使用的完整 XML 字符串。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这个“包”是一个扁平化的 XML 结构，使用 `&lt;pkg:part&gt;` 来模拟 ZIP 包中的文件和目录结构。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            xml_fragments (List[str]): 一个包含原始 OOXML 元素（如段落、表格）字符串的列表。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            styles_xml (Optional[bytes]): 整个 `word/styles.xml` 文件的字节内容。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            numbering_xml (Optional[bytes]): 整个 `word/numbering.xml` 文件的字节内容。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            add_empty_paragraph (bool): 是否在内容末尾添加一个空的 `&lt;w:p/&gt;` 段落。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                                        这对于修复 Office.js 插入内容时，末尾段落样式被“污染”的问题至关重要。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                                        对于正文内容块，应为 True；对于独立的标题，应为 False。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            str: 一个包含了所有必要部分（rels, content_types, styles, numbering, document）的完整 OOXML 包字符串。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                 该字符串经过了压缩，移除了所有换行符。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 获取共享部分</span>
</span></span><span style="display:flex;"><span>        shared_parts <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_ooxml_shared_parts<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 将所有传入的 XML 片段合并成一个单一的内容字符串</span>
</span></span><span style="display:flex;"><span>        combined_content <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>xml_fragments<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 根据参数决定是否在合并后的内容末尾添加一个空段落</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> add_empty_paragraph<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            combined_content <span style="color:#0550ae">+=</span> <span style="color:#0a3069">&#34;&lt;w:p/&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 组装文档部分</span>
</span></span><span style="display:flex;"><span>        document_part <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;&lt;pkg:part pkg:name=&#34;/word/document.xml&#34; pkg:contentType=&#34;application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml&#34;&gt;&lt;pkg:xmlData&gt;&lt;w:document </span><span style="color:#0a3069">{</span>shared_parts<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;ns_declarations&#34;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&gt;&lt;w:body&gt;</span><span style="color:#0a3069">{</span>combined_content<span style="color:#0a3069">}</span><span style="color:#0a3069">&lt;/w:body&gt;&lt;/w:document&gt;&lt;/pkg:xmlData&gt;&lt;/pkg:part&gt;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 组装最终的 OOXML 包</span>
</span></span><span style="display:flex;"><span>        ooxml_package <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;&#34;&#34;</span><span style="color:#0a3069">{</span>shared_parts<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;xml_header&#34;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0a3069">{</span>shared_parts<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;mso_application&#34;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0a3069">{</span>shared_parts<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;package_start&#34;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0a3069">{</span>shared_parts<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_types_part&#34;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0a3069">{</span>shared_parts<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;doc_rels_part&#34;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0a3069">{</span>document_part<span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0a3069">{</span>shared_parts<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;styles_part&#34;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0a3069">{</span>shared_parts<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;numbering_part&#34;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0a3069">{</span>shared_parts<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;package_end&#34;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 移除所有换行和首尾空格，得到单行字符串，便于API调用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>line<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span> <span style="color:#cf222e">for</span> line <span style="color:#0550ae">in</span> ooxml_package<span style="color:#0550ae">.</span>split<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_read_xml</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> path<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">bytes</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从 .docx 压缩包中安全地读取一个指定的 XML 文件。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            path (str): 要读取的文件在压缩包内的路径 (例如 &#34;word/document.xml&#34;)。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Optional[bytes]: 文件的字节内容。如果文件不存在，则返回 None 并记录警告。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>zip_file<span style="color:#0550ae">.</span>open<span style="color:#1f2328">(</span>path<span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> f<span style="color:#0550ae">.</span>read<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> KeyError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;XML 文件未找到: </span><span style="color:#0a3069">{</span>path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_parse_rels</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        解析文档的关系文件 (word/_rels/document.xml.rels)。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这个文件定义了主文档与其他资源（如图片、超链接、页眉页脚）之间的关联。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        我们主要用它来查找图片等内嵌资源的具体文件路径。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, str]: 一个关系字典，键是关系ID (rId)，值是目标文件路径。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        rels_content <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_read_xml<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;word/_rels/document.xml.rels&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> rels_content<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>rels_content<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span>rel<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;Id&#34;</span><span style="color:#1f2328">]:</span> rel<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;Target&#34;</span><span style="color:#1f2328">]</span> <span style="color:#cf222e">for</span> rel <span style="color:#0550ae">in</span> soup<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Relationship&#34;</span><span style="color:#1f2328">)}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_to_points</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> value<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">],</span> unit<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;dxa&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">float</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        将 OOXML 中常用的单位（如 dxa, half-points）转换为标准的“点”(Points)。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - &#39;dxa&#39; (twentieths of a point): 1/20 磅，常用于缩进和间距。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - &#39;half-points&#39;: 1/2 磅，常用于字号。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - &#39;eighth-points&#39;: 1/8 磅。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            value (Optional[str]): 从 XML 中读取的原始值字符串。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            unit (str): 值的单位，默认为 &#39;dxa&#39;。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Optional[float]: 转换后的磅值。如果输入无效，则返回 None。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> value <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            numeric_value <span style="color:#0550ae">=</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>value<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> unit <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;dxa&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> numeric_value <span style="color:#0550ae">/</span> <span style="color:#0550ae">20.0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> unit <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;half-points&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> numeric_value <span style="color:#0550ae">/</span> <span style="color:#0550ae">2.0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> unit <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;eighth-points&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> numeric_value <span style="color:#0550ae">/</span> <span style="color:#0550ae">8.0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> numeric_value
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> <span style="color:#1f2328">(</span>ValueError<span style="color:#1f2328">,</span> TypeError<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_character_properties</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> r_pr_tag<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span>Tag<span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从 &lt;w:rPr&gt; (Run Properties) 标签中提取字符级别的格式信息。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        例如：加粗、斜体、下划线、字号、颜色等。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            r_pr_tag (Optional[Tag]): BeautifulSoup 解析出的 &lt;w:rPr&gt; 标签对象。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 包含字符格式属性的字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> r_pr_tag<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        properties <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> r_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:b&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;bold&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> r_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:i&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;italic&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> u_tag <span style="color:#0550ae">:=</span> r_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:u&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;underline&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> u_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;single&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> r_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:strike&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;strike&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> r_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:vertAlign&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;superscript&#34;</span><span style="color:#1f2328">}):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;superscript&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> r_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:vertAlign&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;subscript&#34;</span><span style="color:#1f2328">}):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;subscript&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>sz <span style="color:#0550ae">:=</span> r_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:sz&#34;</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">and</span> sz<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;size&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_to_points<span style="color:#1f2328">(</span>sz<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;half-points&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>color <span style="color:#0550ae">:=</span> r_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:color&#34;</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">and</span> color<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;color&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> color<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> font_tag <span style="color:#0550ae">:=</span> r_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:rFonts&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;font&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                k<span style="color:#1f2328">:</span> v
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">for</span> k<span style="color:#1f2328">,</span> v <span style="color:#0550ae">in</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;ascii&#34;</span><span style="color:#1f2328">:</span> font_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:ascii&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;hAnsi&#34;</span><span style="color:#1f2328">:</span> font_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:hAnsi&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;eastAsia&#34;</span><span style="color:#1f2328">:</span> font_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:eastAsia&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;hint&#34;</span><span style="color:#1f2328">:</span> font_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:hint&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span><span style="color:#0550ae">.</span>items<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> v <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_paragraph_properties</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> p_pr_tag<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span>Tag<span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从 &lt;w:pPr&gt; (Paragraph Properties) 标签中提取段落级别的格式信息。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        例如：对齐方式、缩进、行距、段前段后间距等。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            p_pr_tag (Optional[Tag]): BeautifulSoup 解析出的 &lt;w:pPr&gt; 标签对象。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 包含段落和默认字符格式属性的字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> p_pr_tag<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        para_props <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>jc <span style="color:#0550ae">:=</span> p_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:jc&#34;</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">and</span> jc<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            para_props<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;alignment&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> jc<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> ind <span style="color:#0550ae">:=</span> p_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:ind&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            para_props<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;indent&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                k<span style="color:#1f2328">:</span> v
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">for</span> k<span style="color:#1f2328">,</span> v <span style="color:#0550ae">in</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;left&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_to_points<span style="color:#1f2328">(</span>ind<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:left&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;right&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_to_points<span style="color:#1f2328">(</span>ind<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:right&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;firstLine&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_to_points<span style="color:#1f2328">(</span>ind<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:firstLine&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;hanging&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_to_points<span style="color:#1f2328">(</span>ind<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:hanging&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span><span style="color:#0550ae">.</span>items<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> v <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> spacing <span style="color:#0550ae">:=</span> p_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:spacing&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            spacing_props <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;before&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_to_points<span style="color:#1f2328">(</span>spacing<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:before&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;after&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_to_points<span style="color:#1f2328">(</span>spacing<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:after&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>line_val <span style="color:#0550ae">:=</span> spacing<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:line&#34;</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">and</span> <span style="color:#1f2328">(</span>line_rule <span style="color:#0550ae">:=</span> spacing<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:lineRule&#34;</span><span style="color:#1f2328">)):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> line_rule <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;auto&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        spacing_props<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;lineHeight&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;mode&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;multiple&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;value&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span><span style="color:#1f2328">(</span>line_val<span style="color:#1f2328">)</span> <span style="color:#0550ae">/</span> <span style="color:#0550ae">240.0</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">except</span> ValueError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">pass</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    spacing_props<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;lineHeight&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;mode&#34;</span><span style="color:#1f2328">:</span> line_rule<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;value&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_to_points<span style="color:#1f2328">(</span>line_val<span style="color:#1f2328">)}</span>
</span></span><span style="display:flex;"><span>            para_props<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;spacing&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>k<span style="color:#1f2328">:</span> v <span style="color:#cf222e">for</span> k<span style="color:#1f2328">,</span> v <span style="color:#0550ae">in</span> spacing_props<span style="color:#0550ae">.</span>items<span style="color:#1f2328">()</span> <span style="color:#cf222e">if</span> v <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 段落属性中可能也包含应用于整个段落的默认字符属性 (&lt;w:rPr&gt;)</span>
</span></span><span style="display:flex;"><span>        char_props <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_character_properties<span style="color:#1f2328">(</span>p_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:rPr&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> para_props<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            result<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;paragraph_properties&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> para_props
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> char_props<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            result<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;character_properties&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> char_props
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_table_properties</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> tbl_pr_tag<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span>Tag<span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从 &lt;w:tblPr&gt; (Table Properties) 标签中提取表格级别的格式信息。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        例如：表格对齐方式、整体宽度等。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            tbl_pr_tag (Optional[Tag]): BeautifulSoup 解析出的 &lt;w:tblPr&gt; 标签对象。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 包含表格格式属性的字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> tbl_pr_tag<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        properties <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>jc_tag <span style="color:#0550ae">:=</span> tbl_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:jc&#34;</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">and</span> jc_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;alignment&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> jc_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>tbl_w_tag <span style="color:#0550ae">:=</span> tbl_pr_tag<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tblW&#34;</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">and</span> tbl_w_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:w&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            properties<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;width&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;value&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_to_points<span style="color:#1f2328">(</span>tbl_w_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:w&#34;</span><span style="color:#1f2328">)),</span> <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> tbl_w_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:type&#34;</span><span style="color:#1f2328">)}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> properties
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_get_outline_level_from_style</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> style_id<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> style_map<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">],</span> visited_styles<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">set</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">int</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        递归获取样式的大纲级别，支持通过 basedOn 继承链追溯。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            style_id (str): 样式ID
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            style_map (Dict[str, Any]): 样式映射字典
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            visited_styles (Optional[set]): 已访问的样式ID集合，用于防止循环引用
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Optional[int]: 大纲级别（0-5对应1-6级标题），如果不是标题样式则返回None
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> visited_styles <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            visited_styles <span style="color:#0550ae">=</span> <span style="color:#6639ba">set</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 防止循环引用</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> style_id <span style="color:#0550ae">in</span> visited_styles<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        visited_styles<span style="color:#0550ae">.</span>add<span style="color:#1f2328">(</span>style_id<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> style_id <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> style_map<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        style_info <span style="color:#0550ae">=</span> style_map<span style="color:#1f2328">[</span>style_id<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 如果当前样式已经有level信息，直接返回</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> style_info<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> style_info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span>  <span style="color:#57606a"># 转换为0-5的范围</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 如果没有level信息，检查是否有basedOn，递归查找父样式</span>
</span></span><span style="display:flex;"><span>        based_on_id <span style="color:#0550ae">=</span> style_info<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;based_on&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> based_on_id<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_outline_level_from_style<span style="color:#1f2328">(</span>based_on_id<span style="color:#1f2328">,</span> style_map<span style="color:#1f2328">,</span> visited_styles<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_get_paragraph_outline_level</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> p_element<span style="color:#1f2328">:</span> Tag<span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">int</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        获取段落的大纲级别，支持三种方式：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        1. 段落直接定义的 w:outlineLvl（document.xml中的直接覆盖）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        2. 段落样式中定义的 w:outlineLvl
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        3. 通过样式继承链追溯的 w:outlineLvl
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            p_element (Tag): 段落元素
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Optional[int]: 大纲级别（1-6），如果不是标题则返回None
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 方法一：检查段落直接定义的 w:outlineLvl（优先级最高）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> p_pr <span style="color:#0550ae">:=</span> p_element<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pPr&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>outline_lvl <span style="color:#0550ae">:=</span> p_pr<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:outlineLvl&#34;</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">and</span> outline_lvl<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                outline_val <span style="color:#0550ae">=</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">(</span>outline_lvl<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 只接受0-5的有效大纲级别（对应1-6级标题）</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#0550ae">0</span> <span style="color:#0550ae">&lt;=</span> outline_val <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">5</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> outline_val <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span>  <span style="color:#57606a"># 转换为1-6的范围</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 方法二和三：通过样式获取大纲级别</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> p_pr <span style="color:#0550ae">:=</span> p_element<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pPr&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> p_style_tag <span style="color:#0550ae">:=</span> p_pr<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pStyle&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                style_id <span style="color:#0550ae">=</span> p_style_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 确保 self.styles 已经初始化</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;styles&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> style_id <span style="color:#0550ae">in</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    style_info <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles<span style="color:#1f2328">[</span>style_id<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> style_info<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">return</span> style_info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_parse_styles</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> styles_xml<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">bytes</span><span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        解析 `word/styles.xml` 文件，提取所有样式定义。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        此函数构建一个以样式ID为键的字典，值为该样式的详细信息（名称、类型、格式属性）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        特别地，它会识别出哪些是“标题”样式（例如 &#34;heading 1&#34;）并记录其级别，
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这是构建文档层级结构的基础。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            styles_xml (Optional[bytes]): `word/styles.xml` 文件的字节内容。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 一个包含所有已解析样式的字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> styles_xml<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>styles_xml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        style_map <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 第一遍：解析所有样式的基本信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> style <span style="color:#0550ae">in</span> soup<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:style&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            style_id <span style="color:#0550ae">=</span> style<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:styleId&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> style_id<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>            style_type <span style="color:#0550ae">=</span> style<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:type&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            name <span style="color:#0550ae">=</span> name_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>name_tag <span style="color:#0550ae">:=</span> style<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:name&#34;</span><span style="color:#1f2328">))</span> <span style="color:#cf222e">else</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 处理段落样式</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> style_type <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;paragraph&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> style<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:default&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;1&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>default_para_style_id <span style="color:#0550ae">=</span> style_id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                level <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>                based_on_id <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 获取basedOn信息</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> based_on_tag <span style="color:#0550ae">:=</span> style<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:basedOn&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    based_on_id <span style="color:#0550ae">=</span> based_on_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 方法一：直接从样式的 &lt;w:pPr&gt;&lt;w:outlineLvl&gt; 标签获取大纲级别</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> p_pr <span style="color:#0550ae">:=</span> style<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pPr&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>outline_lvl <span style="color:#0550ae">:=</span> p_pr<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:outlineLvl&#34;</span><span style="color:#1f2328">))</span> <span style="color:#0550ae">and</span> outline_lvl<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                        outline_val <span style="color:#0550ae">=</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">(</span>outline_lvl<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 只接受0-5的有效大纲级别（对应1-6级标题）</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> <span style="color:#0550ae">0</span> <span style="color:#0550ae">&lt;=</span> outline_val <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">5</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            level <span style="color:#0550ae">=</span> outline_val <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span>  <span style="color:#57606a"># 级别从0开始，我们转为从1开始</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 方法二：如果上面方法失败，尝试从样式名称中用正则匹配 &#34;heading X&#34; 或 &#34;标题 X&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> level <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> <span style="color:#cf222e">match</span> <span style="color:#0550ae">:=</span> re<span style="color:#0550ae">.</span>search<span style="color:#1f2328">(</span><span style="color:#0a3069">r</span><span style="color:#0a3069">&#34;(heading|标题)\s*(\d+)&#34;</span><span style="color:#1f2328">,</span> name<span style="color:#1f2328">,</span> re<span style="color:#0550ae">.</span>IGNORECASE<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                        heading_num <span style="color:#0550ae">=</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">(</span><span style="color:#cf222e">match</span><span style="color:#0550ae">.</span>group<span style="color:#1f2328">(</span><span style="color:#0550ae">2</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 只接受1-6级标题</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">&lt;=</span> heading_num <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">6</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            level <span style="color:#0550ae">=</span> heading_num
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                properties <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_paragraph_properties<span style="color:#1f2328">(</span>style<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pPr&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> r_pr_props <span style="color:#0550ae">:=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_character_properties<span style="color:#1f2328">(</span>style<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:rPr&#34;</span><span style="color:#1f2328">)):</span>
</span></span><span style="display:flex;"><span>                    properties<span style="color:#0550ae">.</span>setdefault<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;character_properties&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{})</span><span style="color:#0550ae">.</span>update<span style="color:#1f2328">(</span>r_pr_props<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                style_map<span style="color:#1f2328">[</span>style_id<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">:</span> level<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> style_type<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;properties&#34;</span><span style="color:#1f2328">:</span> properties<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;based_on&#34;</span><span style="color:#1f2328">:</span> based_on_id<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 处理表格样式</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">elif</span> style_type <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;table&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                table_props <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">:</span> name<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> style_type<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;properties&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_table_properties<span style="color:#1f2328">(</span>style<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tblPr&#34;</span><span style="color:#1f2328">)),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>table_styles<span style="color:#1f2328">[</span>style_id<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> table_props
</span></span><span style="display:flex;"><span>                style_map<span style="color:#1f2328">[</span>style_id<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> table_props
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 第二遍：处理通过basedOn继承的大纲级别（方法三）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> style_id<span style="color:#1f2328">,</span> style_info <span style="color:#0550ae">in</span> style_map<span style="color:#0550ae">.</span>items<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> style_info<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;paragraph&#34;</span> <span style="color:#0550ae">and</span> style_info<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span> <span style="color:#0550ae">and</span> style_info<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;based_on&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 递归查找父样式的大纲级别</span>
</span></span><span style="display:flex;"><span>                inherited_level <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_outline_level_from_style<span style="color:#1f2328">(</span>style_info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;based_on&#34;</span><span style="color:#1f2328">],</span> style_map<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> inherited_level <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span> <span style="color:#0550ae">and</span> <span style="color:#0550ae">0</span> <span style="color:#0550ae">&lt;=</span> inherited_level <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">5</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    style_info<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> inherited_level <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span>  <span style="color:#57606a"># 转换为1-6的范围</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> style_map
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_parse_numbering</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> num_xml<span style="color:#1f2328">:</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">bytes</span><span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        解析 `word/numbering.xml` 文件，提取所有列表编号和项目符号的定义。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        OOXML 中的列表比较复杂，分为 `abstractNum` (抽象定义) 和 `num` (具体实例)。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        此函数将它们解析并关联起来，构建一个以 `numId` 为键的字典，
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        值为该列表各级别的格式定义（如 &#34;1, 2, 3&#34;, &#34;a, b, c&#34;, &#34;•, •, •&#34;）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            num_xml (Optional[bytes]): `word/numbering.xml` 文件的字节内容。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 一个包含所有已解析编号列表定义的字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> num_xml<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>num_xml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 1. 解析抽象编号定义 (abstractNum)</span>
</span></span><span style="display:flex;"><span>        abstract_nums <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> anum <span style="color:#0550ae">in</span> soup<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:abstractNum&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            abstract_num_id <span style="color:#0550ae">=</span> anum<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:abstractNumId&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> abstract_num_id<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>            levels <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> lvl <span style="color:#0550ae">in</span> anum<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:lvl&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                ilvl<span style="color:#1f2328">,</span> num_fmt_tag <span style="color:#0550ae">=</span> lvl<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:ilvl&#34;</span><span style="color:#1f2328">),</span> lvl<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:numFmt&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                lvl_text_tag<span style="color:#1f2328">,</span> start_tag <span style="color:#0550ae">=</span> lvl<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:lvlText&#34;</span><span style="color:#1f2328">),</span> lvl<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:start&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#1f2328">(</span>ilvl <span style="color:#0550ae">and</span> num_fmt_tag<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>                level_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;format&#34;</span><span style="color:#1f2328">:</span> num_fmt_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">:</span> lvl_text_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">if</span> lvl_text_tag <span style="color:#cf222e">else</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;start&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">(</span>start_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">))</span> <span style="color:#cf222e">if</span> start_tag <span style="color:#0550ae">and</span> start_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                levels<span style="color:#1f2328">[</span>ilvl<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> level_data
</span></span><span style="display:flex;"><span>            abstract_nums<span style="color:#1f2328">[</span>abstract_num_id<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> levels
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 2. 解析具体编号实例 (num)，并将其链接到抽象定义</span>
</span></span><span style="display:flex;"><span>        num_map <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> num <span style="color:#0550ae">in</span> soup<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:num&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            num_id <span style="color:#0550ae">=</span> num<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:numId&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> num_id<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> abstract_num_id_tag <span style="color:#0550ae">:=</span> num<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:abstractNumId&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                abstract_num_id <span style="color:#0550ae">=</span> abstract_num_id_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> abstract_num_id <span style="color:#0550ae">in</span> abstract_nums<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    num_map<span style="color:#1f2328">[</span>num_id<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> abstract_nums<span style="color:#1f2328">[</span>abstract_num_id<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> num_map
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_get_image_data</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> r_id<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        根据资源关系ID (rId) 获取图片的 Base64 编码字符串。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        注意：此方法保留用于向后兼容，新代码应使用 _process_image_with_oss
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> r_id <span style="color:#0550ae">in</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>rels<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            target <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>rels<span style="color:#1f2328">[</span>r_id<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">from</span> <span style="color:#24292e">os.path</span> <span style="color:#cf222e">import</span> join<span style="color:#1f2328">,</span> normpath
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 路径需要规范化，因为 target 可能是 &#34;../media/image1.png&#34; 这样的相对路径</span>
</span></span><span style="display:flex;"><span>            base_path <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;word&#34;</span>
</span></span><span style="display:flex;"><span>            image_path <span style="color:#0550ae">=</span> normpath<span style="color:#1f2328">(</span>join<span style="color:#1f2328">(</span>base_path<span style="color:#1f2328">,</span> target<span style="color:#1f2328">))</span><span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\\</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;/&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>zip_file<span style="color:#0550ae">.</span>open<span style="color:#1f2328">(</span>image_path<span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> img_file<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> base64<span style="color:#0550ae">.</span>b64encode<span style="color:#1f2328">(</span>img_file<span style="color:#0550ae">.</span>read<span style="color:#1f2328">())</span><span style="color:#0550ae">.</span>decode<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;utf-8&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span> KeyError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片文件未在压缩包中找到: </span><span style="color:#0a3069">{</span>image_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_process_image_with_oss</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> r_id<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> return_text_placeholder<span style="color:#1f2328">:</span> <span style="color:#6639ba">bool</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Optional<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        处理图片：优先上传到OSS，失败时跳过图片
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            r_id (str): 图片的资源关系ID
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            return_text_placeholder (bool): 是否返回纯文本占位符格式（用于type=&#34;image&#34;数据块）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Optional[str]:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                - 如果OSS上传成功且return_text_placeholder=True：返回OSS key路径（如：protocol-images/2025/08/02/abc123.png）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                - 如果OSS上传成功且return_text_placeholder=False：返回包含OSS占位符的OOXML字符串
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                - 如果OSS上传失败或OSS模块不可用：返回None（跳过图片）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                - 如果图片不存在：返回None
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> r_id <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>rels<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片关系ID未找到: </span><span style="color:#0a3069">{</span>r_id<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        target <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>rels<span style="color:#1f2328">[</span>r_id<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">from</span> <span style="color:#24292e">os.path</span> <span style="color:#cf222e">import</span> join<span style="color:#1f2328">,</span> normpath
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 路径需要规范化</span>
</span></span><span style="display:flex;"><span>        base_path <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;word&#34;</span>
</span></span><span style="display:flex;"><span>        image_path <span style="color:#0550ae">=</span> normpath<span style="color:#1f2328">(</span>join<span style="color:#1f2328">(</span>base_path<span style="color:#1f2328">,</span> target<span style="color:#1f2328">))</span><span style="color:#0550ae">.</span>replace<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\\</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;/&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">with</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>zip_file<span style="color:#0550ae">.</span>open<span style="color:#1f2328">(</span>image_path<span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> img_file<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                image_data <span style="color:#0550ae">=</span> img_file<span style="color:#0550ae">.</span>read<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 尝试直接上传原始图片文件到OSS</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> upload_image_to_oss <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 获取文件扩展名</span>
</span></span><span style="display:flex;"><span>                file_extension <span style="color:#0550ae">=</span> image_path<span style="color:#0550ae">.</span>split<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;.&#34;</span><span style="color:#1f2328">)[</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>lower<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> file_extension <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;png&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;jpg&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;jpeg&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;gif&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;bmp&#34;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                    file_extension <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;png&#34;</span>  <span style="color:#57606a"># 默认扩展名</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 直接上传原始图片数据</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">from</span> <span style="color:#24292e">utils.oss_utils</span> <span style="color:#cf222e">import</span> create_image_placeholder<span style="color:#1f2328">,</span> create_image_text_placeholder<span style="color:#1f2328">,</span> upload_image
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 尝试上传到OSS，最多重试3次</span>
</span></span><span style="display:flex;"><span>                max_retries <span style="color:#0550ae">=</span> <span style="color:#0550ae">3</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">for</span> attempt <span style="color:#0550ae">in</span> <span style="color:#6639ba">range</span><span style="color:#1f2328">(</span>max_retries<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        oss_url <span style="color:#0550ae">=</span> upload_image<span style="color:#1f2328">(</span>image_data<span style="color:#1f2328">,</span> file_extension<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> oss_url<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># OSS上传成功，立即释放图片数据内存并返回占位符</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">del</span> image_data  <span style="color:#57606a"># 立即释放内存</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> return_text_placeholder<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 返回纯文本格式的占位符（用于type=&#34;image&#34;数据块）</span>
</span></span><span style="display:flex;"><span>                                placeholder_text <span style="color:#0550ae">=</span> create_image_text_placeholder<span style="color:#1f2328">(</span>oss_url<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片已上传到OSS，返回文本占位符: </span><span style="color:#0a3069">{</span>oss_url<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">return</span> placeholder_text
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 返回XML格式的占位符（用于OOXML文档中）</span>
</span></span><span style="display:flex;"><span>                                placeholder_xml <span style="color:#0550ae">=</span> create_image_placeholder<span style="color:#1f2328">(</span>oss_url<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片已上传到OSS，返回XML占位符: </span><span style="color:#0a3069">{</span>oss_url<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">return</span> placeholder_xml
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># OSS上传失败，记录并准备重试</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片OSS上传失败，尝试 </span><span style="color:#0a3069">{</span>attempt <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span>max_retries<span style="color:#0a3069">}</span><span style="color:#0a3069">: </span><span style="color:#0a3069">{</span>r_id<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> attempt <span style="color:#0550ae">&lt;</span> max_retries <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">import</span> <span style="color:#24292e">time</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                time<span style="color:#0550ae">.</span>sleep<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>  <span style="color:#57606a"># 等待1秒后重试</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># OSS上传异常，记录并准备重试</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;OSS上传异常，尝试 </span><span style="color:#0a3069">{</span>attempt <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">/</span><span style="color:#0a3069">{</span>max_retries<span style="color:#0a3069">}</span><span style="color:#0a3069">: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> attempt <span style="color:#0550ae">&lt;</span> max_retries <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">import</span> <span style="color:#24292e">time</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                            time<span style="color:#0550ae">.</span>sleep<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>  <span style="color:#57606a"># 等待1秒后重试</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 所有重试都失败了</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">del</span> image_data  <span style="color:#57606a"># 释放原始图片数据内存</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> return_text_placeholder<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 对于 type=&#34;image&#34; 数据块，返回空字符串</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片OSS上传重试</span><span style="color:#0a3069">{</span>max_retries<span style="color:#0a3069">}</span><span style="color:#0a3069">次均失败，返回空字符串: </span><span style="color:#0a3069">{</span>r_id<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 对于OOXML文档中的图片，OSS上传失败时也不插入图片</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片OSS上传重试</span><span style="color:#0a3069">{</span>max_retries<span style="color:#0a3069">}</span><span style="color:#0a3069">次均失败，跳过图片插入: </span><span style="color:#0a3069">{</span>r_id<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># OSS模块不可用的处理</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">del</span> image_data  <span style="color:#57606a"># 释放原始图片数据内存</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> return_text_placeholder<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 对于 type=&#34;image&#34; 数据块，返回空字符串</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OSS模块不可用，type=&#39;image&#39;数据块返回空字符串&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 对于OOXML文档中的图片，OSS不可用时也不插入图片</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;OSS模块不可用，跳过图片插入&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> KeyError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片文件未在压缩包中找到: </span><span style="color:#0a3069">{</span>image_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理图片时发生错误: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_process_paragraph_images</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> paragraph<span style="color:#1f2328">:</span> Tag<span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        处理段落中的图片，将图片上传到OSS并替换为占位符
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            paragraph: BeautifulSoup解析的段落标签
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            str: 处理后的段落XML字符串
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 创建段落的副本以避免修改原始对象</span>
</span></span><span style="display:flex;"><span>        p_copy <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>paragraph<span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> p_copy <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 如果没有找到w:p标签，返回原始内容</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;未找到w:p标签，返回原始段落内容&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>paragraph<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 查找所有图片元素</span>
</span></span><span style="display:flex;"><span>        blip_tags <span style="color:#0550ae">=</span> p_copy<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;a:blip&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> blip_tag <span style="color:#0550ae">in</span> blip_tags<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            r_id <span style="color:#0550ae">=</span> blip_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> r_id<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 处理图片（上传到OSS，失败时跳过）</span>
</span></span><span style="display:flex;"><span>                image_result <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_image_with_oss<span style="color:#1f2328">(</span>r_id<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> image_result <span style="color:#0550ae">and</span> image_result<span style="color:#0550ae">.</span>startswith<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;&lt;w:p&gt;&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 如果返回的是OSS占位符OOXML，提取其中的文本内容</span>
</span></span><span style="display:flex;"><span>                    placeholder_soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>image_result<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    placeholder_texts <span style="color:#0550ae">=</span> placeholder_soup<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:t&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> placeholder_texts<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 找到包含图片的drawing元素，替换为文本</span>
</span></span><span style="display:flex;"><span>                        drawing <span style="color:#0550ae">=</span> blip_tag<span style="color:#0550ae">.</span>find_parent<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:drawing&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> drawing<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 创建新的文本run来替换图片</span>
</span></span><span style="display:flex;"><span>                            new_run <span style="color:#0550ae">=</span> p_copy<span style="color:#0550ae">.</span>new_tag<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:r&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">for</span> text_elem <span style="color:#0550ae">in</span> placeholder_texts<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                new_t <span style="color:#0550ae">=</span> p_copy<span style="color:#0550ae">.</span>new_tag<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:t&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                new_t<span style="color:#0550ae">.</span>string <span style="color:#0550ae">=</span> text_elem<span style="color:#0550ae">.</span>get_text<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                                new_run<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>new_t<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 添加换行</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">if</span> text_elem <span style="color:#0550ae">!=</span> placeholder_texts<span style="color:#1f2328">[</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                                    new_br <span style="color:#0550ae">=</span> p_copy<span style="color:#0550ae">.</span>new_tag<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:br&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                    new_run<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>new_br<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 替换drawing元素</span>
</span></span><span style="display:flex;"><span>                            drawing<span style="color:#0550ae">.</span>replace_with<span style="color:#1f2328">(</span>new_run<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片 </span><span style="color:#0a3069">{</span>r_id<span style="color:#0a3069">}</span><span style="color:#0a3069"> 已替换为OSS占位符&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;未找到图片 </span><span style="color:#0a3069">{</span>r_id<span style="color:#0a3069">}</span><span style="color:#0a3069"> 的drawing父元素&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;图片 </span><span style="color:#0a3069">{</span>r_id<span style="color:#0a3069">}</span><span style="color:#0a3069"> 处理失败，保留原始图片&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>p_copy<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_parse_runs</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> p_tag<span style="color:#1f2328">:</span> Tag<span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        解析一个段落标签(&lt;w:p&gt;)中的所有文本块(&lt;w:r&gt;)，并拼接它们的文本内容(&lt;w:t&gt;)。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        一个段落的文本可能被分割在多个 &#34;run&#34; 中，每个 run 可以有不同的格式。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        此函数只提取纯文本内容。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            p_tag (Tag): BeautifulSoup 解析出的 &lt;w:p&gt; 标签对象。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            str: 该段落的完整纯文本内容。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>t<span style="color:#0550ae">.</span>text <span style="color:#cf222e">for</span> t <span style="color:#0550ae">in</span> p_tag<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:t&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_get_paragraph_text</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> p_element<span style="color:#1f2328">:</span> Any<span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从段落的 XML 元素或字符串中提取纯文本。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这是一个对 `_parse_runs` 的封装，可以处理字符串或 BeautifulSoup 标签。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            p_element (Any): 可以是 &lt;w:p&gt; 元素的 XML 字符串，或 BeautifulSoup 的 Tag 对象。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            str: 段落的纯文本。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>p_element<span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            p_element <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>p_element<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> p_element<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_parse_runs<span style="color:#1f2328">(</span>p_element<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_get_text_from_element</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> element_xml<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从任何给定的 OOXML 元素（字符串格式）中递归地提取所有纯文本。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这对于从一个大的 OOXML 块（可能包含多个段落、表格）中提取全部文本很有用。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            element_xml (str): 包含一个或多个 OOXML 元素的 XML 字符串。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            str: 拼接后的所有纯文本。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>element_xml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        all_text <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> p_tag <span style="color:#0550ae">in</span> soup<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_parse_runs<span style="color:#1f2328">(</span>p_tag<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                all_text<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>text<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>all_text<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_get_text_from_element_fragment</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> fragment<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从内容片段中提取纯文本。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            fragment (str): 内容片段字符串（不包含完整的OOXML包装）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            str: 提取的纯文本
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 为片段创建一个临时的完整OOXML包来解析</span>
</span></span><span style="display:flex;"><span>        temp_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">[</span>fragment<span style="color:#1f2328">],</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span> add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_text_from_element<span style="color:#1f2328">(</span>temp_ooxml<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_get_text_from_cell_content</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> content_list<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]])</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从一个包含多个内容块的列表中提取所有纯文本。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这主要用于处理表格单元格，因为一个单元格可能包含多个段落。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            content_list (List[Dict[str, str]]): 内容块列表，每个块是一个字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            str: 拼接后的所有纯文本。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        full_text <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> block <span style="color:#0550ae">in</span> content_list<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_text_from_element<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                    full_text<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>text<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>full_text<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_kv_from_table_block</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> table_block<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从一个包含表格的 OOXML 内容块中，提取键值对（Key-Value）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        此函数假定表格是两列的结构，第一列是键，第二列是值。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        现在返回的值是完整的 OOXML 包，而不是纯文本。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            table_block (Dict[str, str]): 类型为 &#39;ooxml&#39; 的内容块，其 &#39;data&#39; 字段包含表格的 OOXML。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, str]: 从表格中提取的键值对字典，值为完整的 OOXML 包。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        kv_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> table_block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>        table_xml <span style="color:#0550ae">=</span> table_block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>table_xml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        table <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> table<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> row <span style="color:#0550ae">in</span> table<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tr&#34;</span><span style="color:#1f2328">,</span> recursive<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            cells <span style="color:#0550ae">=</span> row<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tc&#34;</span><span style="color:#1f2328">,</span> recursive<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>cells<span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                key_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_text<span style="color:#1f2328">(</span>cells<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> key_text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 提取第二列的所有内容元素，按原始顺序处理</span>
</span></span><span style="display:flex;"><span>                    content_blocks <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 获取单元格的所有直接子元素（段落和表格），保持原始顺序</span>
</span></span><span style="display:flex;"><span>                    cell_children <span style="color:#0550ae">=</span> cells<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">([</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">],</span> recursive<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">for</span> child <span style="color:#0550ae">in</span> cell_children<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> child<span style="color:#0550ae">.</span>name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 处理段落元素</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 检查段落是否有文本内容，过滤空段落</span>
</span></span><span style="display:flex;"><span>                                paragraph_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_text<span style="color:#1f2328">(</span>child<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> paragraph_text <span style="color:#0550ae">or</span> <span style="color:#0550ae">not</span> paragraph_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">continue</span>  <span style="color:#57606a"># 跳过空段落</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 检查段落是否包含图片</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">if</span> child<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:drawing&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> child<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pict&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#57606a"># 包含图片的段落，直接提取图片并上传到OSS</span>
</span></span><span style="display:flex;"><span>                                    blip_tags <span style="color:#0550ae">=</span> child<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;a:blip&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">if</span> blip_tags<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#57606a"># 如果段落包含图片，为每个图片创建一个image数据块</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#cf222e">for</span> blip_tag <span style="color:#0550ae">in</span> blip_tags<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                            r_id <span style="color:#0550ae">=</span> blip_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#cf222e">if</span> r_id<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                                image_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_image_with_oss<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                                    r_id<span style="color:#1f2328">,</span> return_text_placeholder<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#cf222e">if</span> image_data<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有非空字符串才创建image数据块</span>
</span></span><span style="display:flex;"><span>                                                    content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> image_data<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#57606a"># 如果没有找到图片引用，回退到原来的处理方式</span>
</span></span><span style="display:flex;"><span>                                        processed_paragraph <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_paragraph_images<span style="color:#1f2328">(</span>child<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                        paragraph_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#1f2328">[</span>processed_paragraph<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                        content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> paragraph_ooxml<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#57606a"># 纯文本段落，标记为 ooxml 类型</span>
</span></span><span style="display:flex;"><span>                                    paragraph_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>child<span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                    content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> paragraph_ooxml<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">elif</span> child<span style="color:#0550ae">.</span>name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 处理嵌套表格元素</span>
</span></span><span style="display:flex;"><span>                                table_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>child<span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> table_ooxml<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 如果包装失败，记录错误但继续处理</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;警告：内容包装失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;元素内容: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>child<span style="color:#1f2328">)[:</span><span style="color:#0550ae">200</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 统一返回数组格式 list[object]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> content_blocks<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有当有内容块时才添加</span>
</span></span><span style="display:flex;"><span>                        kv_data<span style="color:#1f2328">[</span>key_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()]</span> <span style="color:#0550ae">=</span> content_blocks
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_kv_from_colon_paragraph_block</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> p_block<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Optional<span style="color:#1f2328">[</span>Tuple<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从一个段落内容块中，提取由冒号分隔的键值对。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        例如，对于文本 &#34;项目名称：XXX项目&#34;，此函数会提取键和对应的完整 OOXML 包。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        支持中英文冒号。现在返回的值是完整的 OOXML 包，而不是纯文本。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            p_block (Dict[str, str]): 类型为 &#39;ooxml&#39; 的内容块，其 &#39;data&#39; 字段包含段落的 OOXML。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Optional[Tuple[str, str]]: 如果成功提取，返回 (键, 完整OOXML包) 元组；否则返回 None。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> p_block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;跳过非ooxml类型的块: </span><span style="color:#0a3069">{</span>p_block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;type&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 首先提取纯文本来判断是否包含冒号</span>
</span></span><span style="display:flex;"><span>        text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_text<span style="color:#1f2328">(</span>p_block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">))</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落文本内容: &#39;</span><span style="color:#0a3069">{</span>text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 兼容中文和英文冒号</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;：&#34;</span> <span style="color:#0550ae">in</span> text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            parts <span style="color:#0550ae">=</span> text<span style="color:#0550ae">.</span>split<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;：&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;找到中文冒号，分割结果: </span><span style="color:#0a3069">{</span>parts<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">elif</span> <span style="color:#0a3069">&#34;:&#34;</span> <span style="color:#0550ae">in</span> text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            parts <span style="color:#0550ae">=</span> text<span style="color:#0550ae">.</span>split<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;找到英文冒号，分割结果: </span><span style="color:#0a3069">{</span>parts<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;未找到冒号，跳过段落: &#39;</span><span style="color:#0a3069">{</span>text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        key <span style="color:#0550ae">=</span> parts<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> key<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;提取到键: &#39;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 检查段落是否包含图片</span>
</span></span><span style="display:flex;"><span>                paragraph_data <span style="color:#0550ae">=</span> p_block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>paragraph_data<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 检查是否包含图片元素</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:drawing&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pict&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    content_type <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;image&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 对包含图片的段落进行OSS处理</span>
</span></span><span style="display:flex;"><span>                    processed_paragraph <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_paragraph_images<span style="color:#1f2328">(</span>soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                    paragraph_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">[</span>processed_paragraph<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    content_type <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;ooxml&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 将整个段落包装成完整的 OOXML 包</span>
</span></span><span style="display:flex;"><span>                    paragraph_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">[</span>paragraph_data<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 使用与 sections 相同的数据结构</span>
</span></span><span style="display:flex;"><span>                value_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> content_type<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> paragraph_ooxml<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> key<span style="color:#1f2328">,</span> value_data
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 如果包装失败，记录错误并返回 None</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;警告：冒号段落包装失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落内容: </span><span style="color:#0a3069">{</span>paragraph_data<span style="color:#1f2328">[:</span><span style="color:#0550ae">200</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_process_title_page_content_blocks</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> content_blocks<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        处理文档标题页（封面）的内容块，从中提取所有的键值对信息。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        它会综合运用表格解析和冒号段落解析两种策略。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            content_blocks (List[Dict[str, str]]): 从文档开头到特定分隔符（如“保密声明”）之间的所有内容块。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, str]: 从标题页提取的所有键值对的集合。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        kv_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;开始处理 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>content_blocks<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个内容块&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> i<span style="color:#1f2328">,</span> block <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>content_blocks<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理第 </span><span style="color:#0a3069">{</span>i <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个块，类型: </span><span style="color:#0a3069">{</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;type&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;跳过非ooxml块&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 如果块是表格，用表格解析器</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;发现表格，使用表格解析器&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                table_kvs <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_table_block<span style="color:#1f2328">(</span>block<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;表格解析结果: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>table_kvs<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span> <span style="color:#cf222e">if</span> table_kvs <span style="color:#cf222e">else</span> <span style="color:#0a3069">&#39;无数据&#39;</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                kv_data<span style="color:#0550ae">.</span>update<span style="color:#1f2328">(</span>table_kvs<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 如果块是段落，用冒号段落解析器</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">elif</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;发现段落，使用冒号段落解析器&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                p_kv <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_colon_paragraph_block<span style="color:#1f2328">(</span>block<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> p_kv<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落解析成功: 键=&#39;</span><span style="color:#0a3069">{</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 统一返回数组格式 list[object]</span>
</span></span><span style="display:flex;"><span>                    kv_data<span style="color:#1f2328">[</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]]</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;段落解析无结果&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;块中既无表格也无段落&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;最终提取到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>kv_data<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个键值对: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>kv_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_process_title_page_content_blocks_optimized</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> content_blocks<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        处理文档标题页（封面）的内容块，从中提取所有的键值对信息（优化版本）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        与原版本的区别：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 处理的是内容片段而非完整OOXML包
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 返回的值也是内容片段格式
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            content_blocks (List[Dict[str, str]]): 从文档开头到特定分隔符之间的所有内容块（片段格式）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, str]: 从标题页提取的所有键值对的集合（值为片段格式）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        kv_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;开始处理 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>content_blocks<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个内容块（优化版本）&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> i<span style="color:#1f2328">,</span> block <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>content_blocks<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理第 </span><span style="color:#0a3069">{</span>i <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个块，类型: </span><span style="color:#0a3069">{</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;type&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;跳过非ooxml块&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 对于片段，需要临时包装成完整OOXML来解析结构</span>
</span></span><span style="display:flex;"><span>            fragment_data <span style="color:#0550ae">=</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            temp_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">[</span>fragment_data<span style="color:#1f2328">],</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span> add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>temp_ooxml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 如果块是表格，用表格解析器</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;发现表格，使用表格解析器&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                table_kvs <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_table_block_optimized<span style="color:#1f2328">(</span>fragment_data<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;表格解析结果: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>table_kvs<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span> <span style="color:#cf222e">if</span> table_kvs <span style="color:#cf222e">else</span> <span style="color:#0a3069">&#39;无数据&#39;</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                kv_data<span style="color:#0550ae">.</span>update<span style="color:#1f2328">(</span>table_kvs<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 如果块是段落，用冒号段落解析器</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">elif</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;发现段落，使用冒号段落解析器&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 首先尝试多键值对解析（适用于签字页等包含多个键值对的长段落）</span>
</span></span><span style="display:flex;"><span>                multiple_kvs <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_multiple_kv_from_paragraph_optimized<span style="color:#1f2328">(</span>fragment_data<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> multiple_kvs<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;多键值对解析成功: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>multiple_kvs<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    kv_data<span style="color:#0550ae">.</span>update<span style="color:#1f2328">(</span>multiple_kvs<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;多键值对解析无结果，尝试单键值对解析&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 如果多键值对解析失败，回退到单键值对解析</span>
</span></span><span style="display:flex;"><span>                    p_kv <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_colon_paragraph_block_optimized<span style="color:#1f2328">(</span>fragment_data<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> p_kv<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;单键值对解析成功: 键=&#39;</span><span style="color:#0a3069">{</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 统一返回数组格式 list[object]</span>
</span></span><span style="display:flex;"><span>                        kv_data<span style="color:#1f2328">[</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;单键值对解析也无结果&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;块中既无表格也无段落&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;最终提取到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>kv_data<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个键值对: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>kv_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_kv_from_table_block_optimized</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> table_fragment<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从一个包含表格的内容片段中，提取键值对（修正版本）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        正确的处理逻辑：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 提取表格右列（value列）的所有内容元素（段落和嵌套表格）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 将这些元素作为独立的内容块，就像sections中的content_blocks一样
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 不保留表格结构，只保留内容元素本身的样式和格式
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 确保每个段落和表格都保持完整的OOXML结构
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            table_fragment (str): 包含表格的内容片段
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, List]: 从表格中提取的键值对字典，值为内容块数组格式。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        kv_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 临时包装成完整OOXML来解析</span>
</span></span><span style="display:flex;"><span>        temp_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">[</span>table_fragment<span style="color:#1f2328">],</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span> add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>temp_ooxml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        table <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> table<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> row <span style="color:#0550ae">in</span> table<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tr&#34;</span><span style="color:#1f2328">,</span> recursive<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            cells <span style="color:#0550ae">=</span> row<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tc&#34;</span><span style="color:#1f2328">,</span> recursive<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>cells<span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                key_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_text<span style="color:#1f2328">(</span>cells<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> key_text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 正确的处理：提取第二列的所有内容元素（段落和嵌套表格），按原始顺序处理</span>
</span></span><span style="display:flex;"><span>                    content_blocks <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 按照XML中的原始顺序处理所有直接子元素</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">for</span> child <span style="color:#0550ae">in</span> cells<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>children<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span>child<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> child<span style="color:#0550ae">.</span>name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;p&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 处理段落元素</span>
</span></span><span style="display:flex;"><span>                                p <span style="color:#0550ae">=</span> child
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 检查段落是否有文本内容，过滤空段落</span>
</span></span><span style="display:flex;"><span>                                paragraph_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_text<span style="color:#1f2328">(</span>p<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> paragraph_text <span style="color:#0550ae">or</span> <span style="color:#0550ae">not</span> paragraph_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">continue</span>  <span style="color:#57606a"># 跳过空段落</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#57606a"># 检查段落是否包含图片</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">if</span> p<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:drawing&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> p<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pict&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#57606a"># 包含图片的段落，直接提取图片并上传到OSS</span>
</span></span><span style="display:flex;"><span>                                        blip_tags <span style="color:#0550ae">=</span> p<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;a:blip&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#cf222e">if</span> blip_tags<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#57606a"># 如果段落包含图片，为每个图片创建一个image数据块</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#cf222e">for</span> blip_tag <span style="color:#0550ae">in</span> blip_tags<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                                r_id <span style="color:#0550ae">=</span> blip_tag<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                                <span style="color:#cf222e">if</span> r_id<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                                    image_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_image_with_oss<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                                        r_id<span style="color:#1f2328">,</span> return_text_placeholder<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>                                                    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                                    <span style="color:#cf222e">if</span> image_data<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有非空字符串才创建image数据块</span>
</span></span><span style="display:flex;"><span>                                                        content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> image_data<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#57606a"># 如果没有找到图片引用，创建内容片段</span>
</span></span><span style="display:flex;"><span>                                            paragraph_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>p<span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>                                            content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> paragraph_fragment<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#57606a"># 纯文本段落，创建内容片段</span>
</span></span><span style="display:flex;"><span>                                        paragraph_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>p<span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>                                        content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> paragraph_fragment<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#57606a"># 如果包装失败，记录错误但继续处理</span>
</span></span><span style="display:flex;"><span>                                    app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落片段创建失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落内容: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>p<span style="color:#1f2328">)[:</span><span style="color:#0550ae">200</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">elif</span> child<span style="color:#0550ae">.</span>name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;tbl&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 处理嵌套表格元素</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#57606a"># 将嵌套表格创建为内容片段</span>
</span></span><span style="display:flex;"><span>                                    table_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>child<span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>                                    content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> table_fragment<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;嵌套表格片段创建失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;表格内容: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>child<span style="color:#1f2328">)[:</span><span style="color:#0550ae">200</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 统一返回数组格式 list[object]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> content_blocks<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有当有内容块时才添加</span>
</span></span><span style="display:flex;"><span>                        kv_data<span style="color:#1f2328">[</span>key_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()]</span> <span style="color:#0550ae">=</span> content_blocks
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_kv_from_colon_paragraph_block_optimized</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> paragraph_fragment<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Optional<span style="color:#1f2328">[</span>Tuple<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从一个段落内容片段中，提取由冒号分隔的键值对（增强版本）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        增强功能：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 通过删除包含key的&lt;w:r&gt;元素来保留完整的value部分
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 保持原段落的样式信息（w:pPr）和其他格式
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 确保value部分的OOXML结构完整
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            paragraph_fragment (str): 包含段落的内容片段
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Optional[Tuple[str, str]]: 如果成功提取，返回 (键, 内容片段) 元组；否则返回 None。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 临时包装成完整OOXML来解析结构</span>
</span></span><span style="display:flex;"><span>        temp_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">[</span>paragraph_fragment<span style="color:#1f2328">],</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span> add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 首先提取纯文本来判断是否包含冒号</span>
</span></span><span style="display:flex;"><span>        text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_text_from_element<span style="color:#1f2328">(</span>temp_ooxml<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落文本内容: &#39;</span><span style="color:#0a3069">{</span>text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 兼容中文和英文冒号</span>
</span></span><span style="display:flex;"><span>        colon_char <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;：&#34;</span> <span style="color:#0550ae">in</span> text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            parts <span style="color:#0550ae">=</span> text<span style="color:#0550ae">.</span>split<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;：&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            colon_char <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;：&#34;</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;找到中文冒号，分割结果: </span><span style="color:#0a3069">{</span>parts<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">elif</span> <span style="color:#0a3069">&#34;:&#34;</span> <span style="color:#0550ae">in</span> text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            parts <span style="color:#0550ae">=</span> text<span style="color:#0550ae">.</span>split<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            colon_char <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;:&#34;</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;找到英文冒号，分割结果: </span><span style="color:#0a3069">{</span>parts<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;未找到冒号，跳过段落: &#39;</span><span style="color:#0a3069">{</span>text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        key <span style="color:#0550ae">=</span> parts<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> key<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;提取到键: &#39;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 关键改进：创建只包含value部分的段落</span>
</span></span><span style="display:flex;"><span>                value_paragraph <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_value_only_paragraph<span style="color:#1f2328">(</span>paragraph_fragment<span style="color:#1f2328">,</span> key<span style="color:#1f2328">,</span> colon_char<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> value_paragraph<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 检查是否包含图片</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> value_paragraph<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:drawing&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> value_paragraph<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pict&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                        content_type <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;image&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        content_type <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;ooxml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 将value段落转换为内容片段</span>
</span></span><span style="display:flex;"><span>                    value_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>value_paragraph<span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>                    value_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> content_type<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> value_fragment<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> key<span style="color:#1f2328">,</span> value_data
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;创建value段落失败&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 如果处理失败，记录错误并返回 None</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;增强段落键值对处理失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落内容: </span><span style="color:#0a3069">{</span>paragraph_fragment<span style="color:#1f2328">[:</span><span style="color:#0550ae">200</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_create_value_only_paragraph</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> paragraph_fragment<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> key<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> colon_char<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        创建一个只包含value部分的段落，删除包含key的&lt;w:r&gt;元素。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            paragraph_fragment (str): 原始段落片段
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            key (str): 要删除的键名
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            colon_char (str): 冒号字符（中文或英文）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            BeautifulSoup Tag: 新的段落元素，只包含value部分
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 解析段落片段</span>
</span></span><span style="display:flex;"><span>            paragraph_xml <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;&lt;w:p xmlns:w=&#34;http://schemas.openxmlformats.org/wordprocessingml/2006/main&#34;&gt;</span><span style="color:#0a3069">{</span>paragraph_fragment<span style="color:#0a3069">}</span><span style="color:#0a3069">&lt;/w:p&gt;&#39;</span>
</span></span><span style="display:flex;"><span>            soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>paragraph_xml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            paragraph <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> paragraph<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 创建新段落，保留原段落的属性</span>
</span></span><span style="display:flex;"><span>            new_paragraph_xml <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;&lt;w:p xmlns:w=&#34;http://schemas.openxmlformats.org/wordprocessingml/2006/main&#34;&gt;&lt;/w:p&gt;&#39;</span>
</span></span><span style="display:flex;"><span>            new_soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>new_paragraph_xml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            new_paragraph <span style="color:#0550ae">=</span> new_soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 复制段落属性（w:pPr）</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> paragraph<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pPr&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">import</span> <span style="color:#24292e">copy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                new_paragraph<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>copy<span style="color:#0550ae">.</span>deepcopy<span style="color:#1f2328">(</span>paragraph<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pPr&#34;</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 分析所有的&lt;w:r&gt;元素，删除包含key的部分，保留value部分</span>
</span></span><span style="display:flex;"><span>            key_with_colon <span style="color:#0550ae">=</span> key <span style="color:#0550ae">+</span> colon_char
</span></span><span style="display:flex;"><span>            found_key <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> run <span style="color:#0550ae">in</span> paragraph<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:r&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                run_text <span style="color:#0550ae">=</span> run<span style="color:#0550ae">.</span>get_text<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> found_key <span style="color:#0550ae">and</span> key_with_colon <span style="color:#0550ae">in</span> run_text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 这个run包含key和冒号，需要处理</span>
</span></span><span style="display:flex;"><span>                    found_key <span style="color:#0550ae">=</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 找到冒号后的内容</span>
</span></span><span style="display:flex;"><span>                    colon_index <span style="color:#0550ae">=</span> run_text<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span>colon_char<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> colon_index <span style="color:#0550ae">&gt;=</span> <span style="color:#0550ae">0</span> <span style="color:#0550ae">and</span> colon_index <span style="color:#0550ae">&lt;</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>run_text<span style="color:#1f2328">)</span> <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 冒号后还有内容，保留这部分</span>
</span></span><span style="display:flex;"><span>                        value_text <span style="color:#0550ae">=</span> run_text<span style="color:#1f2328">[</span>colon_index <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span> <span style="color:#1f2328">:]</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> value_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>  <span style="color:#57606a"># 如果有非空白内容</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">import</span> <span style="color:#24292e">copy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                            new_run <span style="color:#0550ae">=</span> copy<span style="color:#0550ae">.</span>deepcopy<span style="color:#1f2328">(</span>run<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 更新文本内容</span>
</span></span><span style="display:flex;"><span>                            text_element <span style="color:#0550ae">=</span> new_run<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:t&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> text_element<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                text_element<span style="color:#0550ae">.</span>string <span style="color:#0550ae">=</span> value_text
</span></span><span style="display:flex;"><span>                                new_paragraph<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>new_run<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 如果冒号后没有内容，就不添加这个run</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">elif</span> found_key<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># key已经找到，这个run是value的一部分</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">import</span> <span style="color:#24292e">copy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    new_paragraph<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>copy<span style="color:#0550ae">.</span>deepcopy<span style="color:#1f2328">(</span>run<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 如果还没找到key，跳过这个run</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 如果没有找到key，返回None</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> found_key<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;在段落中未找到键: &#39;</span><span style="color:#0a3069">{</span>key_with_colon<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> new_paragraph
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;创建value段落失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_kv_from_ooxml_paragraph_direct</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> paragraph_ooxml<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Tuple<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        直接从OOXML段落中提取键值对，返回(key, value_ooxml, remaining_ooxml)。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这个方法直接在OOXML层面操作，找到包含冒号的段落，
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        将冒号前的部分作为键，冒号后的部分作为值的OOXML。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            paragraph_ooxml (str): 单个段落的OOXML内容
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Tuple[str, str, str]: (键名, 值的OOXML, 剩余的OOXML)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            如果没有找到键值对，返回 (None, None, paragraph_ooxml)
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">from</span> <span style="color:#24292e">bs4</span> <span style="color:#cf222e">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;开始解析段落OOXML: </span><span style="color:#0a3069">{</span>paragraph_ooxml<span style="color:#1f2328">[:</span><span style="color:#0550ae">100</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 先提取段落的纯文本，检查是否包含冒号</span>
</span></span><span style="display:flex;"><span>            temp_soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>paragraph_ooxml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            full_text <span style="color:#0550ae">=</span> temp_soup<span style="color:#0550ae">.</span>get_text<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落完整文本: &#39;</span><span style="color:#0a3069">{</span>full_text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 查找冒号位置</span>
</span></span><span style="display:flex;"><span>            colon_pos <span style="color:#0550ae">=</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> pos<span style="color:#1f2328">,</span> char <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>full_text<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> char <span style="color:#0550ae">in</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;：&#34;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                    colon_pos <span style="color:#0550ae">=</span> pos
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> colon_pos <span style="color:#0550ae">==</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落中未找到冒号，文本: &#39;</span><span style="color:#0a3069">{</span>full_text<span style="color:#1f2328">[:</span><span style="color:#0550ae">100</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> paragraph_ooxml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 提取键名（冒号前的文本）</span>
</span></span><span style="display:flex;"><span>            key_text <span style="color:#0550ae">=</span> full_text<span style="color:#1f2328">[:</span>colon_pos<span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> key_text <span style="color:#0550ae">or</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>key_text<span style="color:#1f2328">)</span> <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">50</span><span style="color:#1f2328">:</span>  <span style="color:#57606a"># 过滤无效键名</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;键名无效: &#39;</span><span style="color:#0a3069">{</span>key_text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> paragraph_ooxml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 提取值（冒号后的文本）</span>
</span></span><span style="display:flex;"><span>            value_text <span style="color:#0550ae">=</span> full_text<span style="color:#1f2328">[</span>colon_pos <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span> <span style="color:#1f2328">:]</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;提取的value_text: &#39;</span><span style="color:#0a3069">{</span>value_text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;, 长度: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>value_text<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> value_text<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 如果值为空，不提取这个键值对</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;键 &#39;</span><span style="color:#0a3069">{</span>key_text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; 的值为空，跳过&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> paragraph_ooxml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;找到键名: &#39;</span><span style="color:#0a3069">{</span>key_text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;, 值: &#39;</span><span style="color:#0a3069">{</span>value_text<span style="color:#1f2328">[:</span><span style="color:#0550ae">50</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 简化处理：直接基于冒号位置创建只包含值的段落</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 重新解析OOXML，修改文本内容</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;原始段落OOXML前100字符: </span><span style="color:#0a3069">{</span>paragraph_ooxml<span style="color:#1f2328">[:</span><span style="color:#0550ae">100</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 添加命名空间声明</span>
</span></span><span style="display:flex;"><span>            ooxml_with_ns <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;&lt;root xmlns:w=&#34;http://schemas.openxmlformats.org/wordprocessingml/2006/main&#34;&gt;</span><span style="color:#0a3069">{</span>paragraph_ooxml<span style="color:#0a3069">}</span><span style="color:#0a3069">&lt;/root&gt;&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>ooxml_with_ns<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            paragraph <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;解析段落: paragraph=</span><span style="color:#0a3069">{</span><span style="color:#0a3069">&#39;找到&#39;</span> <span style="color:#cf222e">if</span> paragraph <span style="color:#cf222e">else</span> <span style="color:#0a3069">&#39;未找到&#39;</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> paragraph<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;未找到段落元素&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> paragraph_ooxml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 找到所有文本元素，移除键名部分，只保留值部分</span>
</span></span><span style="display:flex;"><span>            all_text_elements <span style="color:#0550ae">=</span> paragraph<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:t&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;找到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>all_text_elements<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个文本元素&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> all_text_elements<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;未找到文本元素&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> paragraph_ooxml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 重新构建段落，只包含值的部分</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 先找到冒号的位置，然后重新设置文本</span>
</span></span><span style="display:flex;"><span>            full_text <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">([</span>t<span style="color:#0550ae">.</span>text <span style="color:#cf222e">for</span> t <span style="color:#0550ae">in</span> all_text_elements <span style="color:#cf222e">if</span> t<span style="color:#0550ae">.</span>text<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>            colon_pos <span style="color:#0550ae">=</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> pos<span style="color:#1f2328">,</span> char <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>full_text<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> char <span style="color:#0550ae">in</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;:&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;：&#34;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                    colon_pos <span style="color:#0550ae">=</span> pos
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> colon_pos <span style="color:#0550ae">==</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> paragraph_ooxml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 提取值部分</span>
</span></span><span style="display:flex;"><span>            value_part <span style="color:#0550ae">=</span> full_text<span style="color:#1f2328">[</span>colon_pos <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span> <span style="color:#1f2328">:]</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;提取的值部分: &#39;</span><span style="color:#0a3069">{</span>value_part<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> value_part<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;值部分为空，跳过&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> paragraph_ooxml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 创建新的段落，只包含值</span>
</span></span><span style="display:flex;"><span>            new_paragraph <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>new_tag<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 复制段落属性</span>
</span></span><span style="display:flex;"><span>            ppr <span style="color:#0550ae">=</span> paragraph<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:pPr&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> ppr<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">import</span> <span style="color:#24292e">copy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                new_paragraph<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>copy<span style="color:#0550ae">.</span>deepcopy<span style="color:#1f2328">(</span>ppr<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 创建新的run和文本</span>
</span></span><span style="display:flex;"><span>            new_run <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>new_tag<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:r&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 复制第一个run的属性（如果存在）</span>
</span></span><span style="display:flex;"><span>            first_run <span style="color:#0550ae">=</span> paragraph<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:r&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> first_run <span style="color:#0550ae">and</span> first_run<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:rPr&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">import</span> <span style="color:#24292e">copy</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                new_run<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>copy<span style="color:#0550ae">.</span>deepcopy<span style="color:#1f2328">(</span>first_run<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:rPr&#34;</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 添加值文本</span>
</span></span><span style="display:flex;"><span>            new_t <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>new_tag<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:t&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            new_t<span style="color:#0550ae">.</span>string <span style="color:#0550ae">=</span> value_part
</span></span><span style="display:flex;"><span>            new_run<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>new_t<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            new_paragraph<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>new_run<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 生成值的OOXML</span>
</span></span><span style="display:flex;"><span>            value_ooxml <span style="color:#0550ae">=</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>new_paragraph<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;成功分离键值对: &#39;</span><span style="color:#0a3069">{</span>key_text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; -&gt; 值OOXML长度=</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>value_ooxml<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;返回值: key=&#39;</span><span style="color:#0a3069">{</span>key_text<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;, value_ooxml长度=</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>value_ooxml<span style="color:#1f2328">)</span> <span style="color:#cf222e">if</span> value_ooxml <span style="color:#cf222e">else</span> <span style="color:#0550ae">0</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> key_text<span style="color:#1f2328">,</span> value_ooxml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;OOXML段落解析失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;异常详情: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>e<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">import</span> <span style="color:#24292e">traceback</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;异常堆栈: </span><span style="color:#0a3069">{</span>traceback<span style="color:#0550ae">.</span>format_exc<span style="color:#1f2328">()</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> paragraph_ooxml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_multiple_kv_from_paragraph_optimized</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> paragraph_fragment<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从一个包含多个键值对的长段落中提取所有键值对（优化版本）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这个方法专门处理像签字页这样的情况，其中多个键值对被合并在一个段落中。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            paragraph_fragment (str): 包含多个键值对的段落片段
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 提取的键值对字典
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        kv_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 临时包装成完整OOXML来提取文本</span>
</span></span><span style="display:flex;"><span>        temp_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">[</span>paragraph_fragment<span style="color:#1f2328">],</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span> add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 提取纯文本</span>
</span></span><span style="display:flex;"><span>        text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_text_from_element<span style="color:#1f2328">(</span>temp_ooxml<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;长段落文本内容: &#39;</span><span style="color:#0a3069">{</span>text<span style="color:#1f2328">[:</span><span style="color:#0550ae">200</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 使用正则表达式匹配所有的键值对</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 匹配模式：中文字符+冒号+内容（直到下一个键或段落结束）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">import</span> <span style="color:#24292e">re</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 匹配中文冒号的键值对</span>
</span></span><span style="display:flex;"><span>        chinese_colon_pattern <span style="color:#0550ae">=</span> <span style="color:#0a3069">r</span><span style="color:#0a3069">&#34;([^：\n]+)：([^：]*?)(?=\s*[^：\n]*：|$)&#34;</span>
</span></span><span style="display:flex;"><span>        matches <span style="color:#0550ae">=</span> re<span style="color:#0550ae">.</span>findall<span style="color:#1f2328">(</span>chinese_colon_pattern<span style="color:#1f2328">,</span> text<span style="color:#1f2328">,</span> re<span style="color:#0550ae">.</span>DOTALL<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> key<span style="color:#1f2328">,</span> value <span style="color:#0550ae">in</span> matches<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            key <span style="color:#0550ae">=</span> key<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            value <span style="color:#0550ae">=</span> value<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 过滤掉空键或明显不是键的内容</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> key <span style="color:#0550ae">and</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>key<span style="color:#1f2328">)</span> <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">50</span> <span style="color:#0550ae">and</span> <span style="color:#0550ae">not</span> key<span style="color:#0550ae">.</span>startswith<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;（&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> <span style="color:#0a3069">&#34;申办者&#34;</span> <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> key<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;从长段落提取键值对: &#39;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; -&gt; &#39;</span><span style="color:#0a3069">{</span>value<span style="color:#1f2328">[:</span><span style="color:#0550ae">50</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 创建只包含值的内容片段</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 使用段落解析器来分离键值对，获取只包含值的OOXML</span>
</span></span><span style="display:flex;"><span>                    key_extracted<span style="color:#1f2328">,</span> value_ooxml<span style="color:#1f2328">,</span> _ <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_ooxml_paragraph_direct<span style="color:#1f2328">(</span>paragraph_fragment<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> key_extracted <span style="color:#0550ae">and</span> key_extracted<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span> <span style="color:#0550ae">==</span> key <span style="color:#0550ae">and</span> value_ooxml<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 如果成功分离出键值对，使用只包含值的OOXML</span>
</span></span><span style="display:flex;"><span>                        processed_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span>value_ooxml<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>                        value_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> processed_fragment<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                        kv_data<span style="color:#1f2328">[</span>key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>value_data<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 如果分离失败，回退到原始方法（但这可能包含完整段落）</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;键值对分离失败，使用原始段落: key_extracted=&#39;</span><span style="color:#0a3069">{</span>key_extracted<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;, expected=&#39;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        processed_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span>paragraph_fragment<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>                        value_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> processed_fragment<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                        kv_data<span style="color:#1f2328">[</span>key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>value_data<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理键值对片段失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 如果中文冒号没有匹配到，尝试英文冒号</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> kv_data<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            english_colon_pattern <span style="color:#0550ae">=</span> <span style="color:#0a3069">r</span><span style="color:#0a3069">&#34;([^:\n]+):([^:]*?)(?=\s*[^:\n]*:|$)&#34;</span>
</span></span><span style="display:flex;"><span>            matches <span style="color:#0550ae">=</span> re<span style="color:#0550ae">.</span>findall<span style="color:#1f2328">(</span>english_colon_pattern<span style="color:#1f2328">,</span> text<span style="color:#1f2328">,</span> re<span style="color:#0550ae">.</span>DOTALL<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> key<span style="color:#1f2328">,</span> value <span style="color:#0550ae">in</span> matches<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                key <span style="color:#0550ae">=</span> key<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                value <span style="color:#0550ae">=</span> value<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> key <span style="color:#0550ae">and</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>key<span style="color:#1f2328">)</span> <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">50</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;从长段落提取键值对(英文冒号): &#39;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; -&gt; &#39;</span><span style="color:#0a3069">{</span>value<span style="color:#1f2328">[:</span><span style="color:#0550ae">50</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 创建只包含值的内容片段</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 使用段落解析器来分离键值对，获取只包含值的OOXML</span>
</span></span><span style="display:flex;"><span>                        key_extracted<span style="color:#1f2328">,</span> value_ooxml<span style="color:#1f2328">,</span> _ <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_ooxml_paragraph_direct<span style="color:#1f2328">(</span>paragraph_fragment<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> key_extracted <span style="color:#0550ae">and</span> key_extracted<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span> <span style="color:#0550ae">==</span> key <span style="color:#0550ae">and</span> value_ooxml<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 如果成功分离出键值对，使用只包含值的OOXML</span>
</span></span><span style="display:flex;"><span>                            processed_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span>value_ooxml<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>                            value_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> processed_fragment<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                            kv_data<span style="color:#1f2328">[</span>key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>value_data<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 如果分离失败，回退到原始方法（但这可能包含完整段落）</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;英文冒号键值对分离失败，使用原始段落: key_extracted=&#39;</span><span style="color:#0a3069">{</span>key_extracted<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;, expected=&#39;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            processed_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span>paragraph_fragment<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>                            value_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> processed_fragment<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                            kv_data<span style="color:#1f2328">[</span>key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>value_data<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理键值对片段失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;从长段落提取到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>kv_data<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个键值对: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>kv_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_kv_from_section_direct_ooxml</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> section<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        直接从章节的OOXML内容中提取键值对（新的正确方法）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这个方法遍历章节中的每个内容块，如果是段落且包含冒号，
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        就直接在OOXML层面提取键值对。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            section (Dict[str, Any]): 章节数据
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 提取的键值对字典
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        kv_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        content_blocks <span style="color:#0550ae">=</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;开始处理章节 &#39;</span><span style="color:#0a3069">{</span>section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; 的 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>content_blocks<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个内容块&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> i<span style="color:#1f2328">,</span> block <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>content_blocks<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            block_type <span style="color:#0550ae">=</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            block_data <span style="color:#0550ae">=</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理第 </span><span style="color:#0a3069">{</span>i <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个块，类型: </span><span style="color:#0a3069">{</span>block_type<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> block_type <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 解析OOXML，查找所有段落</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">from</span> <span style="color:#24292e">bs4</span> <span style="color:#cf222e">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 为了正确解析，需要包装在根元素中，并添加命名空间声明</span>
</span></span><span style="display:flex;"><span>                    wrapped_data <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;&lt;root xmlns:w=&#34;http://schemas.openxmlformats.org/wordprocessingml/2006/main&#34;&gt;</span><span style="color:#0a3069">{</span>block_data<span style="color:#0a3069">}</span><span style="color:#0a3069">&lt;/root&gt;&#39;</span>
</span></span><span style="display:flex;"><span>                    soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>wrapped_data<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 检查是否包含表格</span>
</span></span><span style="display:flex;"><span>                    tables <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    paragraphs <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;块中找到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>tables<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个表格，</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>paragraphs<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个段落&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 优先处理表格（签字页通常以表格为主）</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> tables<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;发现表格，使用签字页表格解析器&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">for</span> table <span style="color:#0550ae">in</span> tables<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            table_fragment <span style="color:#0550ae">=</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>table<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            table_kv <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_signature_table_block<span style="color:#1f2328">(</span>table_fragment<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> table_kv<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;表格解析成功: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>table_kv<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                kv_data<span style="color:#0550ae">.</span>update<span style="color:#1f2328">(</span>table_kv<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;表格解析无结果&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 当有表格时，只处理表格外部的段落</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 获取所有表格内部的段落ID，以便排除它们</span>
</span></span><span style="display:flex;"><span>                        table_paragraph_ids <span style="color:#0550ae">=</span> <span style="color:#6639ba">set</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">for</span> table <span style="color:#0550ae">in</span> tables<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">for</span> p <span style="color:#0550ae">in</span> table<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                                para_id <span style="color:#0550ae">=</span> p<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w14:paraId&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> p<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;paraId&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">if</span> para_id<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    table_paragraph_ids<span style="color:#0550ae">.</span>add<span style="color:#1f2328">(</span>para_id<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 只处理不在表格内部的段落</span>
</span></span><span style="display:flex;"><span>                        external_paragraphs <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">for</span> p <span style="color:#0550ae">in</span> paragraphs<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            para_id <span style="color:#0550ae">=</span> p<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w14:paraId&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> p<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;paraId&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> para_id <span style="color:#0550ae">not</span> <span style="color:#0550ae">in</span> table_paragraph_ids<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                external_paragraphs<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>p<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;表格外部段落数量: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>external_paragraphs<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        paragraphs_to_process <span style="color:#0550ae">=</span> external_paragraphs
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 没有表格时，处理所有段落</span>
</span></span><span style="display:flex;"><span>                        paragraphs_to_process <span style="color:#0550ae">=</span> paragraphs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 处理段落</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>paragraphs_to_process<span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;无需处理的段落&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">for</span> j<span style="color:#1f2328">,</span> paragraph <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>paragraphs_to_process<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                        paragraph_ooxml <span style="color:#0550ae">=</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>paragraph<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 尝试从段落中提取键值对</span>
</span></span><span style="display:flex;"><span>                        key<span style="color:#1f2328">,</span> value_ooxml<span style="color:#1f2328">,</span> remaining <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_ooxml_paragraph_direct<span style="color:#1f2328">(</span>paragraph_ooxml<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> key <span style="color:#0550ae">and</span> value_ooxml<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;从段落 </span><span style="color:#0a3069">{</span>j <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 提取到键值对: &#39;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 创建内容片段</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                processed_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span>value_ooxml<span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>                                value_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> processed_fragment<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                <span style="color:#57606a"># 处理重复键名：如果键已存在，生成唯一键名</span>
</span></span><span style="display:flex;"><span>                                unique_key <span style="color:#0550ae">=</span> key
</span></span><span style="display:flex;"><span>                                counter <span style="color:#0550ae">=</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">while</span> unique_key <span style="color:#0550ae">in</span> kv_data<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    counter <span style="color:#0550ae">+=</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>                                    unique_key <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>key<span style="color:#0a3069">}</span><span style="color:#0a3069">_</span><span style="color:#0a3069">{</span>counter<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">if</span> unique_key <span style="color:#0550ae">!=</span> key<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;键名重复，使用唯一键名: &#39;</span><span style="color:#0a3069">{</span>unique_key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                kv_data<span style="color:#1f2328">[</span>unique_key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>value_data<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理键值对片段失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 获取段落文本用于调试</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                temp_soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>paragraph_ooxml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                text_content <span style="color:#0550ae">=</span> temp_soup<span style="color:#0550ae">.</span>get_text<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">if</span> text_content<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落 </span><span style="color:#0a3069">{</span>j <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 未找到键值对，内容: &#39;</span><span style="color:#0a3069">{</span>text_content<span style="color:#1f2328">[:</span><span style="color:#0550ae">50</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#39;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落 </span><span style="color:#0a3069">{</span>j <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 为空段落&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">except</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;段落 </span><span style="color:#0a3069">{</span>j <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 未找到键值对&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;解析OOXML块失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;块数据前200字符: </span><span style="color:#0a3069">{</span>block_data<span style="color:#1f2328">[:</span><span style="color:#0550ae">200</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">elif</span> block_type <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;table&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 处理表格（使用签字页专用的表格解析器）</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;发现表格，使用签字页表格解析器&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                table_kv <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_signature_table_block<span style="color:#1f2328">(</span>block_data<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> table_kv<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;表格解析成功: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>table_kv<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    kv_data<span style="color:#0550ae">.</span>update<span style="color:#1f2328">(</span>table_kv<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;表格解析无结果&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;章节最终提取到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>kv_data<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个键值对: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>kv_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_kv_from_signature_table_block</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> table_fragment<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从签字页表格中提取键值对（专用方法）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        签字页表格的特点：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        1. 表格内的键值对不使用冒号分割，而是左列为键，右列为值
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        2. 键可能已经包含冒号（如&#34;方案标题：&#34;）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        3. 表格可能有2列或3列结构，需要智能处理
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            table_fragment (str): 包含表格的内容片段
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 提取的键值对字典
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        kv_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 临时包装成完整OOXML来解析</span>
</span></span><span style="display:flex;"><span>        temp_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">[</span>table_fragment<span style="color:#1f2328">],</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span> add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>temp_ooxml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        table <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> table<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;开始解析签字页表格&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> row_idx<span style="color:#1f2328">,</span> row <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>table<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tr&#34;</span><span style="color:#1f2328">,</span> recursive<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)):</span>
</span></span><span style="display:flex;"><span>            cells <span style="color:#0550ae">=</span> row<span style="color:#0550ae">.</span>find_all<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tc&#34;</span><span style="color:#1f2328">,</span> recursive<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理第 </span><span style="color:#0a3069">{</span>row_idx <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 行，包含 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>cells<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个单元格&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>cells<span style="color:#1f2328">)</span> <span style="color:#0550ae">&gt;=</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 获取第一个单元格的文本作为键</span>
</span></span><span style="display:flex;"><span>                key_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_text<span style="color:#1f2328">(</span>cells<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> key_text <span style="color:#0550ae">and</span> key_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 清理键名：移除末尾的冒号和空格</span>
</span></span><span style="display:flex;"><span>                    clean_key <span style="color:#0550ae">=</span> key_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span><span style="color:#0550ae">.</span>rstrip<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;：:&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> clean_key<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 获取第二个单元格（或合并后的单元格）的内容作为值</span>
</span></span><span style="display:flex;"><span>                        value_cell <span style="color:#0550ae">=</span> cells<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 检查是否有跨列的情况（gridSpan）</span>
</span></span><span style="display:flex;"><span>                        grid_span <span style="color:#0550ae">=</span> value_cell<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:gridSpan&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> grid_span<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            span_val <span style="color:#0550ae">=</span> grid_span<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:val&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;1&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;检测到跨列单元格，跨度: </span><span style="color:#0a3069">{</span>span_val<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 提取值单元格的所有内容（段落和嵌套表格）</span>
</span></span><span style="display:flex;"><span>                        content_blocks <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 按照XML中的原始顺序处理所有直接子元素</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">for</span> child <span style="color:#0550ae">in</span> value_cell<span style="color:#0550ae">.</span>children<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span>child<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">if</span> child<span style="color:#0550ae">.</span>name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;p&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#57606a"># 处理段落元素</span>
</span></span><span style="display:flex;"><span>                                    paragraph_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_text<span style="color:#1f2328">(</span>child<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">if</span> paragraph_text <span style="color:#0550ae">and</span> paragraph_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                            paragraph_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>child<span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>                                            content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> paragraph_fragment<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理段落片段失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                            <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">elif</span> child<span style="color:#0550ae">.</span>name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;tbl&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#57606a"># 处理嵌套表格元素</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                        table_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>child<span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>                                        content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> table_fragment<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                        app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理嵌套表格片段失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> content_blocks<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;提取到键值对: &#39;</span><span style="color:#0a3069">{</span>clean_key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; -&gt; </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>content_blocks<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个内容块&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            kv_data<span style="color:#1f2328">[</span>clean_key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> content_blocks
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;键 &#39;</span><span style="color:#0a3069">{</span>clean_key<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; 的值为空&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            kv_data<span style="color:#1f2328">[</span>clean_key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;第 </span><span style="color:#0a3069">{</span>row_idx <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 行的键为空&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;第 </span><span style="color:#0a3069">{</span>row_idx <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 行的第一个单元格为空&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;第 </span><span style="color:#0a3069">{</span>row_idx <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 行单元格数量不足（</span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>cells<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> &lt; 2）&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>debug<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;签字页表格解析完成，提取到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>kv_data<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个键值对: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>kv_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> kv_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_summary_from_section_optimized</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> section<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从摘要章节中提取键值对信息（优化版本）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            section (Dict[str, Any]): 摘要章节数据（使用片段格式）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, str]: 提取的键值对信息
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        summary_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> block <span style="color:#0550ae">in</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 检查是否是表格</span>
</span></span><span style="display:flex;"><span>                temp_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">[</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>temp_ooxml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    table_kvs <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_table_block_optimized<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                    summary_data<span style="color:#0550ae">.</span>update<span style="color:#1f2328">(</span>table_kvs<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">elif</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    p_kv <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_colon_paragraph_block_optimized<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> p_kv<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        summary_data<span style="color:#1f2328">[</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> summary_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_extract_signature_from_section_optimized</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> section<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        从签字页章节中提取键值对信息（优化版本）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            section (Dict[str, Any]): 签字页章节数据（使用片段格式）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, str]: 提取的键值对信息
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        signature_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> block <span style="color:#0550ae">in</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 检查是否是表格</span>
</span></span><span style="display:flex;"><span>                temp_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">[</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>temp_ooxml<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    table_kvs <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_table_block_optimized<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                    signature_data<span style="color:#0550ae">.</span>update<span style="color:#1f2328">(</span>table_kvs<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">elif</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:p&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    p_kv <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_colon_paragraph_block_optimized<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> p_kv<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        signature_data<span style="color:#1f2328">[</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>p_kv<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> signature_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_find_section_by_title</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> nodes<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]],</span> title_keyword<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Optional<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        在文档的层级结构中，递归地查找第一个标题包含特定关键字的章节。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        改进后的版本：增加了章节有效性检查，避免误识别手动设置大纲等级的内容。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            nodes (List[Dict[str, Any]]): 要搜索的章节节点列表（即 `self.sections`）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            title_keyword (str): 要在章节标题中搜索的关键字。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Optional[Dict[str, Any]]: 找到的第一个匹配的章节字典。如果没找到，返回 None。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> node <span style="color:#0550ae">in</span> nodes<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 检查是否是有效的标题章节</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_is_valid_heading_section<span style="color:#1f2328">(</span>node<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> title_keyword <span style="color:#0550ae">in</span> node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> node
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 递归搜索子节点</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;children&#34;</span> <span style="color:#0550ae">in</span> node <span style="color:#0550ae">and</span> node<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                found_in_child <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_find_section_by_title<span style="color:#1f2328">(</span>node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]),</span> title_keyword<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> found_in_child<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> found_in_child
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_is_valid_heading_section</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> section<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">bool</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        检查一个章节是否是有效的标题章节。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        现在支持三种标题识别方式后，需要更智能地判断章节的有效性：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        1. 检查章节是否有有效的标题级别
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        2. 检查标题文本是否有意义（不为空或只包含空白字符）
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        3. 检查是否是真正的标题而不是误识别的内容
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            section (Dict[str, Any]): 章节数据
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            bool: 是否是有效的标题章节
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 检查基本属性</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> section <span style="color:#0550ae">or</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">!=</span> <span style="color:#0a3069">&#34;section&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 检查标题级别</span>
</span></span><span style="display:flex;"><span>        level <span style="color:#0550ae">=</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> level <span style="color:#0550ae">is</span> <span style="color:#cf222e">None</span> <span style="color:#0550ae">or</span> <span style="color:#0550ae">not</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>level<span style="color:#1f2328">,</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> level <span style="color:#0550ae">&lt;</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">or</span> level <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">6</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 检查标题文本</span>
</span></span><span style="display:flex;"><span>        title <span style="color:#0550ae">=</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> title<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 检查标题长度（避免误识别很长的内容为标题）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>title<span style="color:#1f2328">)</span> <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">100</span><span style="color:#1f2328">:</span>  <span style="color:#57606a"># 标题通常不会超过100个字符</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_is_section_boundary</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> current_section<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">],</span> next_section<span style="color:#1f2328">:</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">])</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">bool</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        判断两个章节之间是否存在明确的边界。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这个方法用于确定在提取特定章节内容时，是否应该在某个位置停止。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        考虑了手动设置大纲等级的情况。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            current_section (Dict[str, Any]): 当前章节
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            next_section (Dict[str, Any]): 下一个章节
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            bool: 是否存在明确的章节边界
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 如果任一章节无效，不认为是边界</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_is_valid_heading_section<span style="color:#1f2328">(</span>current_section<span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> <span style="color:#0550ae">not</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_is_valid_heading_section<span style="color:#1f2328">(</span>next_section<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        current_level <span style="color:#0550ae">=</span> current_section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        next_level <span style="color:#0550ae">=</span> next_section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 如果下一个章节的级别小于等于当前章节，认为是边界</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 例如：当前是3级标题，下一个是1级、2级或3级标题，都认为是边界</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> next_level <span style="color:#0550ae">&lt;=</span> current_level<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 如果级别差距过大（超过1级），也认为是边界</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 例如：当前是1级标题，下一个是3级标题（跳过了2级），可能是结构错误</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> next_level <span style="color:#0550ae">-</span> current_level <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_find_sections_with_table_by_title</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> nodes<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]],</span> title_keyword<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        在文档的层级结构中，递归地查找所有标题包含特定关键字的章节，并按优先级排序。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        改进后的版本：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        1. 增加了章节有效性检查，避免误识别手动设置大纲等级的内容
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        2. 支持更灵活的关键词匹配
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        3. 优先级规则：如果章节本身包含表格，优先返回；否则查找其子章节中包含表格的章节
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            nodes (List[Dict[str, Any]]): 要搜索的章节节点列表。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            title_keyword (str): 要在章节标题中搜索的关键字。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            List[Dict[str, Any]]: 按优先级排序的匹配章节列表。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        matching_sections <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">def</span> <span style="color:#6639ba">_matches_summary_keywords</span><span style="color:#1f2328">(</span>title<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">bool</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            检查标题是否匹配摘要相关的关键词
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            支持：摘要、内容提要、提要、概要、概述等变体
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> title<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 定义摘要相关的关键词列表</span>
</span></span><span style="display:flex;"><span>            summary_keywords <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;摘要&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;内容提要&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;提要&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;概要&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 检查标题是否包含任何一个关键词</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> keyword <span style="color:#0550ae">in</span> summary_keywords<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> keyword <span style="color:#0550ae">in</span> title<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">def</span> <span style="color:#6639ba">collect_matching_sections</span><span style="color:#1f2328">(</span>nodes_list<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> node <span style="color:#0550ae">in</span> nodes_list<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 首先检查是否是有效的标题章节</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_is_valid_heading_section<span style="color:#1f2328">(</span>node<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 如果不是有效的标题章节，仍然递归检查子节点</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;children&#34;</span> <span style="color:#0550ae">in</span> node <span style="color:#0550ae">and</span> node<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                        collect_matching_sections<span style="color:#1f2328">(</span>node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]))</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                title <span style="color:#0550ae">=</span> node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 如果是查找摘要相关内容，使用特殊的匹配逻辑</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> title_keyword <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;摘要&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> _matches_summary_keywords<span style="color:#1f2328">(</span>title<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                        matching_sections<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 对于其他关键词，使用原来的简单包含匹配</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> title <span style="color:#0550ae">and</span> title_keyword <span style="color:#0550ae">in</span> title<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        matching_sections<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;children&#34;</span> <span style="color:#0550ae">in</span> node <span style="color:#0550ae">and</span> node<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                    collect_matching_sections<span style="color:#1f2328">(</span>node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        collect_matching_sections<span style="color:#1f2328">(</span>nodes<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 按优先级排序：有表格的章节优先</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">def</span> <span style="color:#6639ba">has_table</span><span style="color:#1f2328">(</span>section<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> block <span style="color:#0550ae">in</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">return</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">elif</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 对于图片类型的内容块，检查是否是 OOXML 包格式</span>
</span></span><span style="display:flex;"><span>                    data <span style="color:#0550ae">=</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> data<span style="color:#0550ae">.</span>startswith<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;&lt;?xml&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> <span style="color:#0a3069">&#34;pkg:package&#34;</span> <span style="color:#0550ae">in</span> data<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 这是一个 OOXML 包，检查其中是否包含表格</span>
</span></span><span style="display:flex;"><span>                        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>data<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">return</span> <span style="color:#cf222e">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 将有表格的章节排在前面</span>
</span></span><span style="display:flex;"><span>        sections_with_table <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>s <span style="color:#cf222e">for</span> s <span style="color:#0550ae">in</span> matching_sections <span style="color:#cf222e">if</span> has_table<span style="color:#1f2328">(</span>s<span style="color:#1f2328">)]</span>
</span></span><span style="display:flex;"><span>        sections_without_table <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>s <span style="color:#cf222e">for</span> s <span style="color:#0550ae">in</span> matching_sections <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> has_table<span style="color:#1f2328">(</span>s<span style="color:#1f2328">)]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> sections_with_table <span style="color:#0550ae">+</span> sections_without_table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_generate_table_of_contents</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> sections<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]])</span> <span style="color:#0550ae">-&gt;</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        根据已构建的文档层级结构，生成一个简单的目录（Table of Contents）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这个目录本身也是一个嵌套的列表，反映了文档的章节结构。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            sections (List[Dict[str, Any]]): 文档的顶层章节列表。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            List[Dict[str, Any]]: 表示目录的嵌套列表。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        table_of_contents <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> section <span style="color:#0550ae">in</span> sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> title_text <span style="color:#0550ae">:=</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                title_text <span style="color:#0550ae">=</span> title_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> title_text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>                entry <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">:</span> title_text<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">:</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> children <span style="color:#0550ae">:=</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    child_toc <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_generate_table_of_contents<span style="color:#1f2328">(</span>children<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> child_toc<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        entry<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> child_toc
</span></span><span style="display:flex;"><span>                table_of_contents<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>entry<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> table_of_contents
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_build_document_hierarchy_optimized</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> body_element<span style="color:#1f2328">:</span> Tag<span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        [★★ 优化版本 - 构建文档的层级结构，使用内容片段而非完整OOXML包 ★★]
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        与原版本的区别：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 内容块的data字段只包含内容片段，不包含完整的OOXML包装
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 大大减少了数据重复和文档大小
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - 需要配合shared_ooxml_parts使用
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            body_element (Tag): BeautifulSoup 解析出的 `&lt;w:body&gt;` 标签对象。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            List[Dict[str, Any]]: 一个代表整个文档结构的顶级章节列表。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        node_path<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>  <span style="color:#57606a"># 维护从根到当前节点的路径，像一个栈</span>
</span></span><span style="display:flex;"><span>        result_sections <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>  <span style="color:#57606a"># 最终返回的顶级章节列表</span>
</span></span><span style="display:flex;"><span>        section_content_elements<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Tag<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>  <span style="color:#57606a"># 临时收集当前章节的所有内容元素</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">def</span> <span style="color:#6639ba">_finalize_current_section_optimized</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            辅助函数：完成当前章节的内容收集与打包（优化版本）。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#1f2328">(</span>node_path <span style="color:#0550ae">and</span> section_content_elements<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            current_section <span style="color:#0550ae">=</span> node_path<span style="color:#1f2328">[</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            ooxml_fragments_buffer <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">def</span> <span style="color:#6639ba">package_buffer_optimized</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;&#34;&#34;将缓冲区中的 OOXML 片段打包成一个内容片段。&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> ooxml_fragments_buffer<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 创建内容片段而非完整OOXML包</span>
</span></span><span style="display:flex;"><span>                        content_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">(</span>ooxml_fragments_buffer<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> content_fragment<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 立即清理缓冲区以释放内存</span>
</span></span><span style="display:flex;"><span>                        ooxml_fragments_buffer<span style="color:#0550ae">.</span>clear<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 如果包装失败，记录错误但尝试保存原始内容</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;警告：章节内容片段创建失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;缓冲区内容数量: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>ooxml_fragments_buffer<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 尝试创建一个简单的内容片段</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            simple_content <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>ooxml_fragments_buffer<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> simple_content<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;已保存为简单内容片段&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e2<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;保存简单内容也失败: </span><span style="color:#0a3069">{</span>e2<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 最后的备选方案：保存为原始文本</span>
</span></span><span style="display:flex;"><span>                            raw_content <span style="color:#0550ae">=</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>ooxml_fragments_buffer<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;raw&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> raw_content<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">finally</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        ooxml_fragments_buffer<span style="color:#0550ae">.</span>clear<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 遍历缓存的章节内容元素</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> element <span style="color:#0550ae">in</span> section_content_elements<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 检查元素是否包含图片</span>
</span></span><span style="display:flex;"><span>                blip_tag <span style="color:#0550ae">=</span> element<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;a:blip&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> blip_tag<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 发现图片，需要判断处理方式</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 1. 先打包在它之前的所有 OOXML 内容。</span>
</span></span><span style="display:flex;"><span>                    package_buffer_optimized<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 2. 检查这个包含图片的元素是否也包含表格或其他重要结构</span>
</span></span><span style="display:flex;"><span>                    element_name <span style="color:#0550ae">=</span> element<span style="color:#0550ae">.</span>name <span style="color:#cf222e">if</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0a3069">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span>                    is_table_element <span style="color:#0550ae">=</span> element_name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;tbl&#34;</span>
</span></span><span style="display:flex;"><span>                    contains_table <span style="color:#0550ae">=</span> element<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>                    has_table <span style="color:#0550ae">=</span> is_table_element <span style="color:#0550ae">or</span> contains_table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> has_table<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 如果是包含图片的表格，保留完整的结构作为片段</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;处理包含图片的表格，保留完整结构作为片段&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            content_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">)])</span>
</span></span><span style="display:flex;"><span>                            current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> content_fragment<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;包含图片的表格片段处理成功&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;包装包含图片的表格片段失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">，回退到纯图片模式&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 回退到原来的纯图片处理</span>
</span></span><span style="display:flex;"><span>                            r_id <span style="color:#0550ae">=</span> blip_tag<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                            image_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_image_with_oss<span style="color:#1f2328">(</span>r_id<span style="color:#1f2328">,</span> return_text_placeholder<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> image_data<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有非空字符串才创建image数据块</span>
</span></span><span style="display:flex;"><span>                                current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> image_data<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                ooxml_fragments_buffer<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 纯图片元素，优先上传到OSS</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;处理纯图片元素，优先上传到OSS&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        r_id <span style="color:#0550ae">=</span> blip_tag<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                        image_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_image_with_oss<span style="color:#1f2328">(</span>r_id<span style="color:#1f2328">,</span> return_text_placeholder<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> image_data<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有非空字符串才创建image数据块</span>
</span></span><span style="display:flex;"><span>                            current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> image_data<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;无法处理 rId 为 </span><span style="color:#0a3069">{</span>r_id<span style="color:#0a3069">}</span><span style="color:#0a3069"> 的图片，将此块存为片段&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            ooxml_fragments_buffer<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 如果不是图片，将其 XML 字符串添加到缓冲区</span>
</span></span><span style="display:flex;"><span>                    ooxml_fragments_buffer<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 循环结束后，打包所有剩余的 OOXML 内容</span>
</span></span><span style="display:flex;"><span>            package_buffer_optimized<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 立即清理所有临时数据以释放内存</span>
</span></span><span style="display:flex;"><span>            section_content_elements<span style="color:#0550ae">.</span>clear<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            ooxml_fragments_buffer<span style="color:#0550ae">.</span>clear<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># --- 主循环：遍历 body 内所有元素 ---</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> element <span style="color:#0550ae">in</span> body_element<span style="color:#0550ae">.</span>children<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">,</span> Tag<span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> <span style="color:#0550ae">not</span> element<span style="color:#0550ae">.</span>name<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            item_level<span style="color:#1f2328">,</span> title_text <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 判断当前元素是否是一个&#34;标题&#34;段落</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> element<span style="color:#0550ae">.</span>name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;p&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 使用新的综合方法检测段落的大纲级别</span>
</span></span><span style="display:flex;"><span>                item_level <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_outline_level<span style="color:#1f2328">(</span>element<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> item_level <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    title_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_text<span style="color:#1f2328">(</span>element<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 如果是标题，则开启新章节</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 注意：忽略标题文本为空或只包含空白字符的标题段落，避免创建空章节</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> item_level <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span> <span style="color:#0550ae">and</span> title_text <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span> <span style="color:#0550ae">and</span> title_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 1. 先完成并打包前一个章节的内容</span>
</span></span><span style="display:flex;"><span>                _finalize_current_section_optimized<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 2. 为标题本身生成一个内容片段</span>
</span></span><span style="display:flex;"><span>                title_fragment <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_create_content_fragment<span style="color:#1f2328">([</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">)],</span> add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 3. 创建新的章节节点</span>
</span></span><span style="display:flex;"><span>                section_node <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;section&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">:</span> item_level<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">:</span> title_text<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;title_fragment&#34;</span><span style="color:#1f2328">:</span> title_fragment<span style="color:#1f2328">,</span>  <span style="color:#57606a"># 存储标题的内容片段</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 4. 调整节点在层级树中的位置</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">while</span> node_path <span style="color:#0550ae">and</span> node_path<span style="color:#1f2328">[</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">&gt;=</span> item_level<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    node_path<span style="color:#0550ae">.</span>pop<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> node_path<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 如果路径不为空，作为子节点</span>
</span></span><span style="display:flex;"><span>                    node_path<span style="color:#1f2328">[</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>section_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>  <span style="color:#57606a"># 否则作为顶级节点</span>
</span></span><span style="display:flex;"><span>                    result_sections<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>section_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                node_path<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>section_node<span style="color:#1f2328">)</span>  <span style="color:#57606a"># 将当前节点压入路径栈</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 如果不是标题，就作为当前章节的内容元素收集起来</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> node_path<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    section_content_elements<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>element<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 文档末尾，处理最后一个章节的内容</span>
</span></span><span style="display:flex;"><span>        _finalize_current_section_optimized<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> result_sections
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">_build_document_hierarchy</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> body_element<span style="color:#1f2328">:</span> Tag<span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        [★★ 核心函数 - 构建文档的层级结构 ★★]
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        此函数遍历 `&lt;w:body&gt;` 中的所有顶级元素（段落、表格等），
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        通过识别应用了“标题”样式的段落，来构建一个嵌套的树状（或层级）结构。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        处理流程：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        1. 遍历 body 的每个子元素。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        2. 如果元素是一个标题段落，则认为一个旧章节结束，一个新章节开始。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        3. 将旧章节缓存的内容（段落、表格、图片）打包处理，存入旧章节的 `content_blocks`。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        4. 创建新的章节节点，并根据标题级别放入层级结构的正确位置。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        5. 如果元素不是标题，则将其追加到当前章节的内容缓存中。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        6. 在处理过程中，图片会被识别并单独作为一个 &#34;image&#34; 类型的块，其他都是 &#34;ooxml&#34; 块。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            body_element (Tag): BeautifulSoup 解析出的 `&lt;w:body&gt;` 标签对象。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            List[Dict[str, Any]]: 一个代表整个文档结构的顶级章节列表。每个章节都是一个字典，
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                                  可能包含 `children` 字段来表示子章节。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        node_path<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>  <span style="color:#57606a"># 维护从根到当前节点的路径，像一个栈</span>
</span></span><span style="display:flex;"><span>        result_sections <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>  <span style="color:#57606a"># 最终返回的顶级章节列表</span>
</span></span><span style="display:flex;"><span>        section_content_elements<span style="color:#1f2328">:</span> List<span style="color:#1f2328">[</span>Tag<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>  <span style="color:#57606a"># 临时收集当前章节的所有内容元素</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">def</span> <span style="color:#6639ba">_finalize_current_section</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            辅助函数：完成当前章节的内容收集与打包。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            当遇到新标题或文档结束时调用。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#1f2328">(</span>node_path <span style="color:#0550ae">and</span> section_content_elements<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            current_section <span style="color:#0550ae">=</span> node_path<span style="color:#1f2328">[</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            ooxml_fragments_buffer <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">def</span> <span style="color:#6639ba">package_buffer</span><span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#0a3069">&#34;&#34;&#34;将缓冲区中的 OOXML 片段打包成一个内容块。&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> ooxml_fragments_buffer<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        complete_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                            ooxml_fragments_buffer<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> complete_ooxml<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 立即清理缓冲区以释放内存</span>
</span></span><span style="display:flex;"><span>                        ooxml_fragments_buffer<span style="color:#0550ae">.</span>clear<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 如果包装失败，记录错误但尝试保存原始内容</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;警告：章节内容包装失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;缓冲区内容数量: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>ooxml_fragments_buffer<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 尝试创建一个简单的 OOXML 包，至少保留内容</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            simple_content <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>ooxml_fragments_buffer<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> simple_content<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;已保存为简单 OOXML 内容块&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e2<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;保存简单内容也失败: </span><span style="color:#0a3069">{</span>e2<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 最后的备选方案：保存为原始文本</span>
</span></span><span style="display:flex;"><span>                            raw_content <span style="color:#0550ae">=</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>ooxml_fragments_buffer<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;raw&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> raw_content<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">finally</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        ooxml_fragments_buffer<span style="color:#0550ae">.</span>clear<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 遍历缓存的章节内容元素</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> element <span style="color:#0550ae">in</span> section_content_elements<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 检查元素是否包含图片</span>
</span></span><span style="display:flex;"><span>                blip_tag <span style="color:#0550ae">=</span> element<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;a:blip&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> blip_tag<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 发现图片，需要判断处理方式</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 1. 先打包在它之前的所有 OOXML 内容。</span>
</span></span><span style="display:flex;"><span>                    package_buffer<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 2. 检查这个包含图片的元素是否也包含表格或其他重要结构</span>
</span></span><span style="display:flex;"><span>                    element_name <span style="color:#0550ae">=</span> element<span style="color:#0550ae">.</span>name <span style="color:#cf222e">if</span> <span style="color:#6639ba">hasattr</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;name&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">else</span> <span style="color:#0a3069">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 如果元素本身就是表格，或者包含表格子元素</span>
</span></span><span style="display:flex;"><span>                    is_table_element <span style="color:#0550ae">=</span> element_name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;tbl&#34;</span>  <span style="color:#57606a"># 去掉命名空间前缀</span>
</span></span><span style="display:flex;"><span>                    contains_table <span style="color:#0550ae">=</span> element<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>                    has_table <span style="color:#0550ae">=</span> is_table_element <span style="color:#0550ae">or</span> contains_table
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;发现包含图片的元素: </span><span style="color:#0a3069">{</span>element_name<span style="color:#0a3069">}</span><span style="color:#0a3069">, 是表格元素: </span><span style="color:#0a3069">{</span>is_table_element<span style="color:#0a3069">}</span><span style="color:#0a3069">, 包含表格: </span><span style="color:#0a3069">{</span>contains_table<span style="color:#0a3069">}</span><span style="color:#0a3069">, 最终判断: </span><span style="color:#0a3069">{</span>has_table<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> has_table<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 如果是包含图片的表格，保留完整的 OOXML 结构</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 标记为 ooxml 类型，这样可以正常提取表格数据</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;处理包含图片的表格，保留完整OOXML结构&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            complete_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 标记为 ooxml 类型，这样表格提取逻辑可以正常工作</span>
</span></span><span style="display:flex;"><span>                            current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> complete_ooxml<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;包含图片的表格处理成功&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;包装包含图片的表格失败: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">，回退到纯图片模式&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 回退到原来的纯图片处理，但使用OSS优化</span>
</span></span><span style="display:flex;"><span>                            r_id <span style="color:#0550ae">=</span> blip_tag<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                            image_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_image_with_oss<span style="color:#1f2328">(</span>r_id<span style="color:#1f2328">,</span> return_text_placeholder<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">if</span> image_data<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有非空字符串才创建image数据块</span>
</span></span><span style="display:flex;"><span>                                current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> image_data<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                                ooxml_fragments_buffer<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 纯图片元素（如独立的图片段落），优先上传到OSS</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;处理纯图片元素，优先上传到OSS&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        r_id <span style="color:#0550ae">=</span> blip_tag<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                        image_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_image_with_oss<span style="color:#1f2328">(</span>r_id<span style="color:#1f2328">,</span> return_text_placeholder<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> image_data<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有非空字符串才创建image数据块</span>
</span></span><span style="display:flex;"><span>                            current_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> image_data<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;无法处理 rId 为 </span><span style="color:#0a3069">{</span>r_id<span style="color:#0a3069">}</span><span style="color:#0a3069"> 的图片，将此块存为 ooxml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            ooxml_fragments_buffer<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a"># 如果不是图片，将其 XML 字符串添加到缓冲区</span>
</span></span><span style="display:flex;"><span>                    ooxml_fragments_buffer<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 循环结束后，打包所有剩余的 OOXML 内容</span>
</span></span><span style="display:flex;"><span>            package_buffer<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 立即清理所有临时数据以释放内存</span>
</span></span><span style="display:flex;"><span>            section_content_elements<span style="color:#0550ae">.</span>clear<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>            ooxml_fragments_buffer<span style="color:#0550ae">.</span>clear<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># --- 主循环：遍历 body 内所有元素 ---</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> element <span style="color:#0550ae">in</span> body_element<span style="color:#0550ae">.</span>children<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">,</span> Tag<span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> <span style="color:#0550ae">not</span> element<span style="color:#0550ae">.</span>name<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            item_level<span style="color:#1f2328">,</span> title_text <span style="color:#0550ae">=</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 判断当前元素是否是一个“标题”段落</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> element<span style="color:#0550ae">.</span>name <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;p&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 使用新的综合方法检测段落的大纲级别</span>
</span></span><span style="display:flex;"><span>                item_level <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_outline_level<span style="color:#1f2328">(</span>element<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> item_level <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    title_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_paragraph_text<span style="color:#1f2328">(</span>element<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 如果是标题，则开启新章节</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 注意：忽略标题文本为空或只包含空白字符的标题段落，避免创建空章节</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> item_level <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span> <span style="color:#0550ae">and</span> title_text <span style="color:#0550ae">is</span> <span style="color:#0550ae">not</span> <span style="color:#cf222e">None</span> <span style="color:#0550ae">and</span> title_text<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 1. 先完成并打包前一个章节的内容</span>
</span></span><span style="display:flex;"><span>                _finalize_current_section<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 2. 为标题本身生成一个独立的、完整的 OOXML 包</span>
</span></span><span style="display:flex;"><span>                title_ooxml <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">)],</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span> add_empty_paragraph<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 3. 创建新的章节节点</span>
</span></span><span style="display:flex;"><span>                section_node <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;section&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">:</span> item_level<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">:</span> title_text<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;title_ooxml&#34;</span><span style="color:#1f2328">:</span> title_ooxml<span style="color:#1f2328">,</span>  <span style="color:#57606a"># 存储标题的独立OOXML包</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[],</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[],</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 4. 调整节点在层级树中的位置</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">while</span> node_path <span style="color:#0550ae">and</span> node_path<span style="color:#1f2328">[</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">&gt;=</span> item_level<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    node_path<span style="color:#0550ae">.</span>pop<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> node_path<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 如果路径不为空，作为子节点</span>
</span></span><span style="display:flex;"><span>                    node_path<span style="color:#1f2328">[</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">][</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>section_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>  <span style="color:#57606a"># 否则作为顶级节点</span>
</span></span><span style="display:flex;"><span>                    result_sections<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>section_node<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                node_path<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>section_node<span style="color:#1f2328">)</span>  <span style="color:#57606a"># 将当前节点压入路径栈</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 如果不是标题，就作为当前章节的内容元素收集起来</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> node_path<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    section_content_elements<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>element<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 文档末尾，处理最后一个章节的内容</span>
</span></span><span style="display:flex;"><span>        _finalize_current_section<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> result_sections
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">parse_to_structured_dict</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> extract_keys_only<span style="color:#1f2328">:</span> <span style="color:#6639ba">bool</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        执行完整的解析流程，返回最终的结构化字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        这个字典包含两个顶级键:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - &#34;sections&#34;: 由 `_build_document_hierarchy` 生成的文档层级结构。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        - &#34;key_information&#34;: 从特定章节（封面、摘要、签字页）提取的键值对信息。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            extract_keys_only (bool): 如果为 True，则在 key_information 中只保留键，值设为空字符串。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                                      这在需要生成待填写的模板时很有用。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">            Dict[str, Any]: 包含完整解析结果的字典。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>doc_xml_content<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>doc_xml_content<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        body <span style="color:#0550ae">=</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:body&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> body<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 1. 构建文档的层级内容结构</span>
</span></span><span style="display:flex;"><span>        hierarchical_content <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_build_document_hierarchy<span style="color:#1f2328">(</span>body<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 2. 基于层级结构生成目录</span>
</span></span><span style="display:flex;"><span>        table_of_contents <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_generate_table_of_contents<span style="color:#1f2328">(</span>hierarchical_content<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 3. 为了提取封面等信息，我们需要一个线性的内容块列表</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">#    这部分逻辑有些重复，但为了兼容现有的键值提取方法而保留。</span>
</span></span><span style="display:flex;"><span>        linear_content_blocks <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> element <span style="color:#0550ae">in</span> body<span style="color:#0550ae">.</span>children<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> <span style="color:#0550ae">not</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">,</span> Tag<span style="color:#1f2328">)</span> <span style="color:#0550ae">or</span> <span style="color:#0550ae">not</span> element<span style="color:#0550ae">.</span>name<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>            blip_tag <span style="color:#0550ae">=</span> element<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;a:blip&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">:</span> <span style="color:#cf222e">True</span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> blip_tag<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                r_id <span style="color:#0550ae">=</span> blip_tag<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;r:embed&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 使用OSS优化的图片处理方法</span>
</span></span><span style="display:flex;"><span>                image_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_image_with_oss<span style="color:#1f2328">(</span>r_id<span style="color:#1f2328">,</span> return_text_placeholder<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> image_data<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 只有非空字符串才创建image数据块</span>
</span></span><span style="display:flex;"><span>                    linear_content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> image_data<span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    linear_content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                linear_content_blocks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_package_complete_ooxml<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>element<span style="color:#1f2328">)],</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>styles_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>numbering_xml_content<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 立即释放soup和body对象以节省内存</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">del</span> soup<span style="color:#1f2328">,</span> body
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 强制垃圾回收以释放内存</span>
</span></span><span style="display:flex;"><span>        gc<span style="color:#0550ae">.</span>collect<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 4. 提取特定部分的信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 4.1 提取封面信息：找到“保密声明”作为封面结束的标志</span>
</span></span><span style="display:flex;"><span>        title_page_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        split_index <span style="color:#0550ae">=</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> i<span style="color:#1f2328">,</span> block <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>linear_content_blocks<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                element_text <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_get_text_from_element<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> element_text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    cleaned_text <span style="color:#0550ae">=</span> re<span style="color:#0550ae">.</span>sub<span style="color:#1f2328">(</span><span style="color:#0a3069">r</span><span style="color:#0a3069">&#34;\s+&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">,</span> element_text<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;保密声明&#34;</span> <span style="color:#0550ae">in</span> cleaned_text <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#34;保密申明&#34;</span> <span style="color:#0550ae">in</span> cleaned_text <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#34;声明&#34;</span> <span style="color:#0550ae">in</span> cleaned_text <span style="color:#0550ae">or</span> <span style="color:#0a3069">&#34;保密&#34;</span> <span style="color:#0550ae">in</span> cleaned_text<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        split_index <span style="color:#0550ae">=</span> i
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> split_index <span style="color:#0550ae">!=</span> <span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            title_page_blocks <span style="color:#0550ae">=</span> linear_content_blocks<span style="color:#1f2328">[:</span>split_index<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>            title_page_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_title_page_content_blocks<span style="color:#1f2328">(</span>title_page_blocks<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;未找到 &#39;保密声明&#39;或&#39;保密申明&#39;，无法提取标题页信息。&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 4.2 提取方案摘要信息</span>
</span></span><span style="display:flex;"><span>        summary_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 使用新的方法查找包含&#34;摘要&#34;关键字的章节，优先返回有表格的章节</span>
</span></span><span style="display:flex;"><span>        summary_sections <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_find_sections_with_table_by_title<span style="color:#1f2328">(</span>hierarchical_content<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;摘要&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> summary_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 遍历找到的章节，查找第一个包含表格的章节</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> summary_section <span style="color:#0550ae">in</span> summary_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">for</span> block <span style="color:#0550ae">in</span> summary_section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        soup <span style="color:#0550ae">=</span> BeautifulSoup<span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;xml&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> soup<span style="color:#0550ae">.</span>find<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;w:tbl&#34;</span><span style="color:#1f2328">):</span>  <span style="color:#57606a"># 摘要信息通常在表格里</span>
</span></span><span style="display:flex;"><span>                            table_kv_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_extract_kv_from_table_block<span style="color:#1f2328">(</span>block<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 保持内容块格式，不转换为简单字典</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">for</span> key<span style="color:#1f2328">,</span> value_blocks <span style="color:#0550ae">in</span> table_kv_data<span style="color:#0550ae">.</span>items<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#cf222e">if</span> value_blocks <span style="color:#0550ae">and</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>value_blocks<span style="color:#1f2328">,</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#57606a"># 直接使用内容块格式，与其他部分保持一致</span>
</span></span><span style="display:flex;"><span>                                    summary_data<span style="color:#1f2328">[</span>key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> value_blocks
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;在章节 &#39;</span><span style="color:#0a3069">{</span>summary_section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; 中找到摘要表格数据，提取了 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>summary_data<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个键值对&#34;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> summary_data<span style="color:#1f2328">:</span>  <span style="color:#57606a"># 如果已经找到数据，跳出外层循环</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 4.3 提取签字页信息</span>
</span></span><span style="display:flex;"><span>        signature_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 调试：列出所有章节标题</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">def</span> <span style="color:#6639ba">list_all_section_titles</span><span style="color:#1f2328">(</span>nodes<span style="color:#1f2328">,</span> level<span style="color:#0550ae">=</span><span style="color:#0550ae">0</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            titles <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> node <span style="color:#0550ae">in</span> nodes<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                title <span style="color:#0550ae">=</span> node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> title<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    titles<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span><span style="color:#0a3069">&#39;  &#39;</span> <span style="color:#0550ae">*</span> level<span style="color:#0a3069">}</span><span style="color:#0a3069">[级别</span><span style="color:#0a3069">{</span>node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;level&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">] </span><span style="color:#0a3069">{</span>title<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    titles<span style="color:#0550ae">.</span>extend<span style="color:#1f2328">(</span>list_all_section_titles<span style="color:#1f2328">(</span>node<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">],</span> level <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> titles
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        all_titles <span style="color:#0550ae">=</span> list_all_section_titles<span style="color:#1f2328">(</span>hierarchical_content<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;文档中所有章节标题:</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span> <span style="color:#0550ae">+</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#0550ae">.</span>join<span style="color:#1f2328">(</span>all_titles<span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 调试：专门查找包含签字相关关键词的章节</span>
</span></span><span style="display:flex;"><span>        signature_keywords <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;签字&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;签字页&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;方案签字&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;批准签字&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        found_signature_sections <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">def</span> <span style="color:#6639ba">find_signature_related_sections</span><span style="color:#1f2328">(</span>nodes<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            sections <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> node <span style="color:#0550ae">in</span> nodes<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                title <span style="color:#0550ae">=</span> node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> title<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">for</span> keyword <span style="color:#0550ae">in</span> signature_keywords<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> keyword <span style="color:#0550ae">in</span> title<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            sections<span style="color:#0550ae">.</span>append<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">:</span> title<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#0a3069">&#34;keyword&#34;</span><span style="color:#1f2328">:</span> keyword<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">:</span> node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">),</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#0a3069">&#34;has_content&#34;</span><span style="color:#1f2328">:</span> <span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]))</span> <span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#0a3069">&#34;content_block_types&#34;</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>                                        block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">for</span> block <span style="color:#0550ae">in</span> node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[])</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> node<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    sections<span style="color:#0550ae">.</span>extend<span style="color:#1f2328">(</span>find_signature_related_sections<span style="color:#1f2328">(</span>node<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;children&#34;</span><span style="color:#1f2328">]))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">return</span> sections
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        found_signature_sections <span style="color:#0550ae">=</span> find_signature_related_sections<span style="color:#1f2328">(</span>hierarchical_content<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> found_signature_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;找到的签字相关章节:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> section <span style="color:#0550ae">in</span> found_signature_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;  - 标题: &#39;</span><span style="color:#0a3069">{</span>section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;title&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#39; (匹配关键词: </span><span style="color:#0a3069">{</span>section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;keyword&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">, 级别: </span><span style="color:#0a3069">{</span>section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;level&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">)&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    内容块数量: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;content_block_types&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]))</span><span style="color:#0a3069">}</span><span style="color:#0a3069">, 类型: </span><span style="color:#0a3069">{</span>section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;content_block_types&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[])</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;未找到任何包含签字相关关键词的章节&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 查找所有包含&#34;签字&#34;的章节，而不是只找第一个</span>
</span></span><span style="display:flex;"><span>        signature_sections <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_find_sections_with_table_by_title<span style="color:#1f2328">(</span>hierarchical_content<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;签字&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> signature_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;找到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>signature_sections<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个签字相关章节&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 合并所有签字章节的内容块</span>
</span></span><span style="display:flex;"><span>            all_signature_blocks <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> section <span style="color:#0550ae">in</span> signature_sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                section_title <span style="color:#0550ae">=</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                section_blocks <span style="color:#0550ae">=</span> section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[])</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理签字章节: &#39;</span><span style="color:#0a3069">{</span>section_title<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;, 包含 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>section_blocks<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个内容块&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                all_signature_blocks<span style="color:#0550ae">.</span>extend<span style="color:#1f2328">(</span>section_blocks<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;总共收集到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>all_signature_blocks<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个签字页内容块&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 使用与标题页相同的处理逻辑：同时处理表格和冒号段落</span>
</span></span><span style="display:flex;"><span>            signature_data <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>_process_title_page_content_blocks<span style="color:#1f2328">(</span>all_signature_blocks<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> signature_data<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;成功提取签字页数据: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>signature_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;签字页数据提取为空&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>warning<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;未找到任何包含签字相关关键词的章节&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 5. 如果设置了 extract_keys_only，则清空所有提取到的值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> extract_keys_only<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;检测到 extract_keys_only=True，将清空 key_information 中相关字段的 value。&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            title_page_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>key<span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#cf222e">for</span> key <span style="color:#0550ae">in</span> title_page_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">()}</span>
</span></span><span style="display:flex;"><span>            summary_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>key<span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#cf222e">for</span> key <span style="color:#0550ae">in</span> summary_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">()}</span>
</span></span><span style="display:flex;"><span>            signature_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>key<span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#cf222e">for</span> key <span style="color:#0550ae">in</span> signature_data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">()}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 6. 组装 key_information 部分，使用更严格的条件来判断字典是否“有意义”。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a">#    这个判断对 extract_keys_only 为 true 和 false 的情况都有效。</span>
</span></span><span style="display:flex;"><span>        key_information <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 提取到的原始数据源</span>
</span></span><span style="display:flex;"><span>        sources <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;title_page&#34;</span><span style="color:#1f2328">:</span> title_page_data<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;protocol_summary&#34;</span><span style="color:#1f2328">:</span> summary_data<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;approval_signature_page&#34;</span><span style="color:#1f2328">:</span> signature_data<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> extract_keys_only<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># --- 模式一：只提取键 ---</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 只要原始解析出了数据（字典不为空），就保留其结构，并将所有值置为空字符串</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;模式: extract_keys_only=True. 保留键，值置空。&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> key<span style="color:#1f2328">,</span> data_dict <span style="color:#0550ae">in</span> sources<span style="color:#0550ae">.</span>items<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 过滤掉key为空字符串的特殊情况</span>
</span></span><span style="display:flex;"><span>                cleaned_keys_dict <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>k<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">():</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#cf222e">for</span> k <span style="color:#0550ae">in</span> data_dict<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">()</span> <span style="color:#cf222e">if</span> k <span style="color:#0550ae">and</span> k<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> cleaned_keys_dict<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    key_information<span style="color:#1f2328">[</span>key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> cleaned_keys_dict
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># --- 模式二：提取键和值 ---</span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 现在值可能是单个内容块或内容块数组，与 sections 保持一致</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;模式: extract_keys_only=False. 提取有效键值对（段落级内容块格式）。&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">for</span> key<span style="color:#1f2328">,</span> data_dict <span style="color:#0550ae">in</span> sources<span style="color:#0550ae">.</span>items<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                cleaned_data <span style="color:#0550ae">=</span> <span style="color:#1f2328">{}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">for</span> k<span style="color:#1f2328">,</span> v <span style="color:#0550ae">in</span> data_dict<span style="color:#0550ae">.</span>items<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">if</span> k <span style="color:#0550ae">and</span> k<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span> <span style="color:#0550ae">and</span> v<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#57606a"># 检查值是否为有效的数据结构（统一为 list[object] 格式）</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>v<span style="color:#1f2328">,</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> <span style="color:#6639ba">all</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#6639ba">isinstance</span><span style="color:#1f2328">(</span>item<span style="color:#1f2328">,</span> <span style="color:#6639ba">dict</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">and</span> item<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">in</span> <span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">and</span> item<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#cf222e">for</span> item <span style="color:#0550ae">in</span> v
</span></span><span style="display:flex;"><span>                        <span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#57606a"># 内容块数组</span>
</span></span><span style="display:flex;"><span>                            cleaned_data<span style="color:#1f2328">[</span>k<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()]</span> <span style="color:#0550ae">=</span> v
</span></span><span style="display:flex;"><span>                <span style="color:#57606a"># 只有当清洗后字典仍有内容时，才将其加入最终结果</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> cleaned_data<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    key_information<span style="color:#1f2328">[</span>key<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> cleaned_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 目录（table_of_contents）不受影响，只要有就添加</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> table_of_contents<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            key_information<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;table_of_contents&#34;</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> table_of_contents
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 返回最终结果</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;sections&#34;</span><span style="color:#1f2328">:</span> hierarchical_content<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;key_information&#34;</span><span style="color:#1f2328">:</span> key_information<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">extract_structured_protocol</span><span style="color:#1f2328">(</span>docx_path<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> extract_keys_only<span style="color:#1f2328">:</span> <span style="color:#6639ba">bool</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">False</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> Dict<span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> Any<span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    一个顶层的 API 函数，封装了 DocxParser 的实例化和调用过程。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    这是外部调用者应该使用的主要入口点。它隐藏了内部实现的复杂性。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    现在统一使用优化版本，将shared_ooxml_parts抽出来，减少数据冗余。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    参数:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        docx_path (str): 指向 .docx 文件的路径。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        extract_keys_only (bool): 是否只提取键名，用于生成模板。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    返回:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        Dict[str, Any]: 从文档中提取的结构化数据，包含shared_ooxml_parts字段。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                       格式: {
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                           &#34;shared_ooxml_parts&#34;: {...},
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                           &#34;sections&#34;: [...],
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                           &#34;key_information&#34;: {...}
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">                       }
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    异常:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        FileNotFoundError: 如果提供的 docx_path 不存在。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">        Exception: 在解析过程中发生的任何其他未捕获的异常。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;开始解析 DOCX 文件: </span><span style="color:#0a3069">{</span>docx_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        parser <span style="color:#0550ae">=</span> DocxParser<span style="color:#1f2328">(</span>docx_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 统一使用优化版本，返回包含shared_ooxml_parts的数据结构</span>
</span></span><span style="display:flex;"><span>        structured_data <span style="color:#0550ae">=</span> parser<span style="color:#0550ae">.</span>parse_to_optimized_dict<span style="color:#1f2328">(</span>extract_keys_only<span style="color:#0550ae">=</span>extract_keys_only<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;文件解析成功: </span><span style="color:#0a3069">{</span>docx_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> structured_data
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> FileNotFoundError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;文件未找到: </span><span style="color:#0a3069">{</span>docx_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;解析文件时发生未知错误: </span><span style="color:#0a3069">{</span>docx_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span> exc_info<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#953800">__name__</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;__main__&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    这是一个主执行块，用于直接运行此脚本进行测试和调试。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    它会：
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    1. 指定一个 .docx 文件路径。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    2. 调用解析函数。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    3. 将结果以格式化的 JSON 形式保存到文件中。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    4. 在控制台打印出解析结果的概览和一些关键的检查项。
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">try</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># file_path = &#34;../data/标题提取.docx&#34;</span>
</span></span><span style="display:flex;"><span>        file_path <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;../data/方案最全/YXC08_8. 临床研究方案_Ver 2.3-P01-15+27-89-D2102(YP)-PH11519(JC).docx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 本地调试也使用优化版本，与OSS存储保持一致</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#0550ae">=</span> extract_structured_protocol<span style="color:#1f2328">(</span>file_path<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 提取各部分数据</span>
</span></span><span style="display:flex;"><span>        sections_data <span style="color:#0550ae">=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;sections&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[])</span>
</span></span><span style="display:flex;"><span>        key_information <span style="color:#0550ae">=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;key_information&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>        shared_ooxml_parts <span style="color:#0550ae">=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;shared_ooxml_parts&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 生成两个独立的JSON文件，模拟OSS存储格式</span>
</span></span><span style="display:flex;"><span>        sections_json <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;sections&#34;</span><span style="color:#1f2328">:</span> sections_data<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;shared_ooxml_parts&#34;</span><span style="color:#1f2328">:</span> shared_ooxml_parts<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        key_information_json <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span><span style="color:#0a3069">&#34;key_information&#34;</span><span style="color:#1f2328">:</span> key_information<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;shared_ooxml_parts&#34;</span><span style="color:#1f2328">:</span> shared_ooxml_parts<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 保存sections JSON</span>
</span></span><span style="display:flex;"><span>        sections_filename <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;../data/output/sections_debug.json&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>sections_filename<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;w&#34;</span><span style="color:#1f2328">,</span> encoding<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;utf-8&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            json<span style="color:#0550ae">.</span>dump<span style="color:#1f2328">(</span>sections_json<span style="color:#1f2328">,</span> f<span style="color:#1f2328">,</span> ensure_ascii<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> indent<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 保存key_information JSON</span>
</span></span><span style="display:flex;"><span>        key_info_filename <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;../data/output/key_information_debug.json&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>key_info_filename<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;w&#34;</span><span style="color:#1f2328">,</span> encoding<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;utf-8&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            json<span style="color:#0550ae">.</span>dump<span style="color:#1f2328">(</span>key_information_json<span style="color:#1f2328">,</span> f<span style="color:#1f2328">,</span> ensure_ascii<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> indent<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># 保存完整数据（用于调试对比）</span>
</span></span><span style="display:flex;"><span>        full_filename <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;../data/output/full_debug.json&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">with</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span>full_filename<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;w&#34;</span><span style="color:#1f2328">,</span> encoding<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;utf-8&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">as</span> f<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            json<span style="color:#0550ae">.</span>dump<span style="color:#1f2328">(</span>data<span style="color:#1f2328">,</span> f<span style="color:#1f2328">,</span> ensure_ascii<span style="color:#0550ae">=</span><span style="color:#cf222e">False</span><span style="color:#1f2328">,</span> indent<span style="color:#0550ae">=</span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;解析完成！结果已保存到:&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;  - sections JSON: </span><span style="color:#0a3069">{</span>sections_filename<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;  - key_information JSON: </span><span style="color:#0a3069">{</span>key_info_filename<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;  - 完整数据: </span><span style="color:#0a3069">{</span>full_filename<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;--- 解析结果概览 ---&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;顶层键: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>data<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> sections <span style="color:#0550ae">:=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;sections&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;共找到 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>sections<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个顶级章节。&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> sections<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                first_section <span style="color:#0550ae">=</span> sections<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#0a3069">f</span><span style="color:#0a3069">&#39;第一个顶级章节: 级别=</span><span style="color:#0a3069">{</span>first_section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;level&#34;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">, 标题=&#34;</span><span style="color:#0a3069">{</span>first_section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;title&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#0a3069">&#34;title_fragment&#34;</span> <span style="color:#0550ae">in</span> first_section <span style="color:#0550ae">and</span> first_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;title_fragment&#34;</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>                    title_fragment <span style="color:#0550ae">=</span> first_section<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;title_fragment&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;  - [√] 章节包含 &#39;title_fragment&#39; 字段，数据长度: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>title_fragment<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                    app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;  - [X] 字段缺失：章节 &#39;title_fragment&#39; 字段缺失或为空。&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;第一个顶级章节包含 </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>first_section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;content_blocks&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">[]))</span><span style="color:#0a3069">}</span><span style="color:#0a3069"> 个内容块。&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> content_blocks <span style="color:#0550ae">:=</span> first_section<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;content_blocks&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">for</span> i<span style="color:#1f2328">,</span> block <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>content_blocks<span style="color:#1f2328">[:</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]):</span>
</span></span><span style="display:flex;"><span>                        app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;  - 内容块 </span><span style="color:#0a3069">{</span>i <span style="color:#0550ae">+</span> <span style="color:#0550ae">1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">: 类型=</span><span style="color:#0a3069">{</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;type&#39;</span><span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">if</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;image&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    图片数据长度: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;data&#39;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">))</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#cf222e">elif</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type&#34;</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#34;ooxml&#34;</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                            fragment_data <span style="color:#0550ae">=</span> block<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;data&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;    OOXML 片段长度: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>fragment_data<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> ki <span style="color:#0550ae">:=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;key_information&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">key_information 包含: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>ki<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;标题页键值对数量: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>ki<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;title_page&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{}))</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;协议摘要键值对数量: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>ki<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;protocol_summary&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{}))</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;审批签字页键值对数量: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>ki<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;approval_signature_page&#39;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">{}))</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#57606a"># 检查目录</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> toc <span style="color:#0550ae">:=</span> ki<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;table_of_contents&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>                app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;目录条目数量: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span>toc<span style="color:#1f2328">)</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">if</span> shared_parts <span style="color:#0550ae">:=</span> data<span style="color:#0550ae">.</span>get<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;shared_ooxml_parts&#34;</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">shared_ooxml_parts 包含字段: </span><span style="color:#0a3069">{</span><span style="color:#6639ba">list</span><span style="color:#1f2328">(</span>shared_parts<span style="color:#0550ae">.</span>keys<span style="color:#1f2328">())</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            total_shared_size <span style="color:#0550ae">=</span> <span style="color:#6639ba">sum</span><span style="color:#1f2328">(</span><span style="color:#6639ba">len</span><span style="color:#1f2328">(</span><span style="color:#6639ba">str</span><span style="color:#1f2328">(</span>v<span style="color:#1f2328">))</span> <span style="color:#cf222e">for</span> v <span style="color:#0550ae">in</span> shared_parts<span style="color:#0550ae">.</span>values<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>            app_logger<span style="color:#0550ae">.</span>info<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;共享部分总大小: </span><span style="color:#0a3069">{</span>total_shared_size<span style="color:#0a3069">}</span><span style="color:#0a3069"> 字符&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> FileNotFoundError<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;错误: 找不到文件 &#39;</span><span style="color:#0a3069">{</span>file_path<span style="color:#0a3069">}</span><span style="color:#0a3069">&#39;。请确保文件路径正确，或修改 &#39;file_path&#39; 变量。&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">except</span> Exception <span style="color:#cf222e">as</span> e<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        app_logger<span style="color:#0550ae">.</span>error<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;处理过程中发生错误: </span><span style="color:#0a3069">{</span>e<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span> exc_info<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span></code></pre></div><p>如果出现以下情况，请向bio工具发送消息：</p>
<ul>
<li>用户要求您保存或忘记信息。
<ul>
<li>这样的请求可能使用各种短语，包括但不限于：&ldquo;记住&hellip;&quot;，&ldquo;存储这个&rdquo;，&ldquo;添加到记忆&rdquo;，&ldquo;注意&hellip;&quot;，&ldquo;忘记&hellip;&quot;，&ldquo;删除这个&quot;等。</li>
<li><strong>任何时候</strong>用户消息包含这些短语或类似短语时，都要思考他们是否在要求您保存或忘记信息。</li>
<li><strong>任何时候</strong>您确定用户在要求您保存或忘记信息时，您都应该<strong>始终</strong>调用bio工具，即使所请求的信息已经存储，看起来极其琐碎或短暂等。</li>
<li><strong>任何时候</strong>您不确定用户是否在要求您保存或忘记信息时，您<strong>必须</strong>在后续消息中向用户寻求澄清。</li>
<li><strong>任何时候</strong>您要向用户发送包含诸如&quot;注意&rdquo;、&ldquo;收到&rdquo;、&ldquo;我会记住&quot;或类似短语的消息时，您应该确保在向用户发送此消息之前先调用bio工具。</li>
</ul>
</li>
<li>用户分享了在未来对话中有用且长期有效的信息。
<ul>
<li>一个指标是如果用户说诸如&quot;从现在开始&rdquo;、&ldquo;将来&rdquo;、&ldquo;今后&quot;等。</li>
<li><strong>任何时候</strong>用户分享了可能在未来几个月或几年内都真实的信息时，都要思考是否值得保存在记忆中。</li>
<li>如果用户信息可能会改变您在类似情况下的未来响应，那么它就值得保存在记忆中。</li>
</ul>
</li>
</ul>
<h4 id="何时不使用bio工具">何时不使用bio工具</h4>
<p>不要存储随机、琐碎或过于个人化的事实。特别是避免：</p>
<ul>
<li><strong>过于个人化</strong>的细节，可能会让人感到毛骨悚然。</li>
<li><strong>短暂</strong>的事实，很快就不重要了。</li>
<li><strong>随机</strong>的细节，缺乏明确的未来相关性。</li>
<li><strong>冗余</strong>的信息，我们已经知道的关于用户的信息。
不要保存从用户试图翻译或重写的文本中提取的信息。
<strong>永远不要</strong>存储属于以下<strong>敏感数据</strong>类别的信息，除非用户明确要求：</li>
<li><strong>直接</strong>断言用户个人属性的信息，例如：
<ul>
<li>种族、民族或宗教</li>
<li>具体的犯罪记录细节（轻微的非刑事法律问题除外）</li>
<li>精确的地理位置数据（街道地址/坐标）</li>
<li>明确识别用户个人属性（例如，&ldquo;User是拉丁裔&rdquo;，&ldquo;User认同基督教&rdquo;，&ldquo;User是LGBTQ+&quot;）。</li>
<li>工会会员资格或工会参与</li>
<li>政治派别或批判性/有政治观点的观点</li>
<li>健康信息（医疗状况、心理健康问题、诊断、性生活）</li>
</ul>
</li>
<li>但是，您可以存储不是明确识别但仍然敏感的信息，例如：
<ul>
<li>讨论兴趣、隶属关系或后勤而不明确断言个人属性的文本（例如，&ldquo;User是来自台湾的国际学生&rdquo;）。</li>
<li>对兴趣或隶属关系的合理提及而不明确断言身份（例如，&ldquo;User经常参与LGBTQ+倡导内容&rdquo;）。
如顶部所述，<strong>所有</strong>上述指令的例外情况是，如果用户明确要求您保存或忘记信息。在这种情况下，您应该<strong>始终</strong>调用bio工具以尊重他们的请求。</li>
</ul>
</li>
</ul>
<h2 id="2-canmore">2 canmore</h2>
<p>canmore工具创建和更新在对话旁边&quot;画布&quot;中显示的文本文档
如果用户要求&quot;使用画布&rdquo;、&ldquo;制作画布&quot;或类似要求，您可以假设这是使用canmore的请求，除非他们指的是HTML画布元素。
此工具有3个功能，如下所列。</p>
<h2 id="canmorecreate_textdoc">canmore.create_textdoc</h2>
<p>创建一个新的文本文档以在画布中显示。仅当您100%确定用户想要迭代长文档或代码文件，或者他们明确要求画布时才使用。
期望一个遵循此模式的JSON字符串：
{
name: string,
type: &ldquo;document&rdquo; | &ldquo;code/python&rdquo; | &ldquo;code/javascript&rdquo; | &ldquo;code/html&rdquo; | &ldquo;code/java&rdquo; | &hellip;,
content: string,
}
对于除上面明确列出的代码语言之外的其他语言，使用&quot;code/languagename&rdquo;，例如&quot;code/cpp&rdquo;。
类型&quot;code/react&quot;和&quot;code/html&quot;可以在ChatGPT的UI中预览。如果用户要求用于预览的代码（例如应用程序、游戏、网站），默认为&quot;code/react&rdquo;。
编写React时：</p>
<ul>
<li>默认导出React组件。</li>
<li>使用Tailwind进行样式设计，无需导入。</li>
<li>所有NPM库都可用。</li>
<li>使用shadcn/ui作为基本组件（例如import { Card, CardContent } from &ldquo;@/components/ui/card&quot;或import { Button } from &ldquo;@/components/ui/button&rdquo;），使用lucide-react作为图标，使用recharts作为图表。</li>
<li>代码应该是生产就绪的，具有最小、干净的美学。</li>
<li>遵循这些样式指南：
<ul>
<li>不同的字体大小（例如，标题用xl，文本用base）。</li>
<li>使用Framer Motion进行动画。</li>
<li>基于网格的布局以避免混乱。</li>
<li>2xl圆角，卡片/按钮的柔和阴影。</li>
<li>适当的内边距（至少p-2）。</li>
<li>考虑添加过滤器/排序控件、搜索输入或下拉菜单以进行组织。</li>
</ul>
</li>
</ul>
<h2 id="canmoreupdate_textdoc">canmore.update_textdoc</h2>
<p>更新当前文本文档。除非已经创建了文本文档，否则不要使用此功能。
期望一个遵循此模式的JSON字符串：
{
updates: {
pattern: string,
multiple: boolean,
replacement: string,
}[],
}
每个pattern和replacement必须是有效的Python正则表达式（与re.finditer一起使用）和替换字符串（与re.Match.expand一起使用）。
<strong>始终</strong>使用单个更新和&rdquo;.<em>&ldquo;作为模式来重写代码文本文档（type=&ldquo;code/</em>&quot;）。
文档文本文档（type=&ldquo;document&rdquo;）通常应使用&rdquo;.*&ldquo;重写，除非用户请求仅更改孤立的、特定的且不影响内容其他部分的小部分。</p>
<h2 id="canmorecomment_textdoc">canmore.comment_textdoc</h2>
<p>评论当前文本文档。除非已经创建了文本文档，否则不要使用此功能。
每个评论必须是关于如何改进文本文档的具体和可行的建议。对于更高级别的反馈，请在聊天中回复。
期望一个遵循此模式的JSON字符串：
{
comments: {
pattern: string,
comment: string,
}[],
}
每个pattern必须是有效的Python正则表达式（与re.search一起使用）。</p>
<h2 id="3-image_gen">3 image_gen</h2>
<p>// image_gen工具使您能够根据描述生成图像，并根据特定说明编辑现有图像。在以下情况下使用：
// - 用户请求基于场景描述的图像，例如图表、肖像、漫画、表情包或任何其他视觉内容。
// - 用户希望使用特定更改修改附加的图像，包括添加或删除元素、更改颜色、提高质量/分辨率或转换样式（例如，卡通、油画）。
// 指南：
// - 直接生成图像而无需重新确认或澄清，除非用户要求包含他们自己的图像。如果用户请求包含他们自己的图像，即使他们要求您根据已经知道的内容生成，也要简单地建议他们提供自己的图像，以便您可以生成更准确的响应。如果他们已经在当前对话中分享了自己的图像，那么您可以生成该图像。如果您要生成包含他们的图像，您<strong>必须至少一次</strong>要求用户上传自己的图像。这非常重要——用一个自然的澄清问题来做。
// - 每次图像生成后，不要提及与下载相关的任何内容。不要总结图像。不要提出后续问题。生成图像后不要说任何话。
// - 始终使用此工具进行图像编辑，除非用户明确要求其他方式。除非特别指示，否则不要使用python工具进行图像编辑。
// - 如果用户的请求违反我们的内容政策，您提出的任何建议必须与原始违规行为有足够的不同。在响应中清楚地区分您的建议与原始意图。
namespace image_gen {
type text2im = (_: {
prompt?: string,
size?: string,
n?: number,
transparent_background?: boolean,
referenced_image_ids?: string[],
}) =&gt; any;
} // namespace image_gen</p>
<h2 id="4-python">4 python</h2>
<p>当您向python发送包含Python代码的消息时，它将在有状态的Jupyter笔记本环境中执行。python将以执行输出响应，或在60.0秒后超时。&rsquo;/mnt/data&rsquo;的驱动器可用于保存和持久化用户文件。此会话的互联网访问被禁用。不要进行外部Web请求或API调用，因为它们会失败。
使用caas_jupyter_tools.display_dataframe_to_user(name: str, dataframe: pandas.DataFrame) -&gt; None在有益于用户时可视化呈现pandas DataFrames。
为用户制作图表时：1)永远不要使用seaborn，2)给每个图表自己独立的绘图（没有子图），3)永远不要设置任何特定的颜色——除非用户明确要求。
我重复：为用户制作图表时：1)使用matplotlib而不是seaborn，2)给每个图表自己独立的绘图，3)永远不要指定颜色或matplotlib样式——除非用户明确要求。
如果您要生成文件：</p>
<ul>
<li>您必须为每个支持的文件格式使用指示的库。（不要假设任何其他库可用）：
<ul>
<li>pdf &ndash;&gt; reportlab</li>
<li>docx &ndash;&gt; python-docx</li>
<li>xlsx &ndash;&gt; openpyxl</li>
<li>pptx &ndash;&gt; python-pptx</li>
<li>csv &ndash;&gt; pandas</li>
<li>rtf &ndash;&gt; pypandoc</li>
<li>txt &ndash;&gt; pypandoc</li>
<li>md &ndash;&gt; pypandoc</li>
<li>ods &ndash;&gt; odfpy</li>
<li>odt &ndash;&gt; odfpy</li>
<li>odp &ndash;&gt; odfpy</li>
</ul>
</li>
<li>如果您要生成pdf
<ul>
<li>您必须优先使用reportlab.platypus而不是canvas生成文本内容</li>
<li>如果您要生成韩语、中文或日语文本，您必须使用以下内置的UnicodeCIDFont。要使用这些字体，您必须调用pdfmetrics.registerFont(UnicodeCIDFont(font_name))并将样式应用于所有文本元素
<ul>
<li>韩语 &ndash;&gt; HeiseiMin-W3或HeiseiKakuGo-W5</li>
<li>简体中文 &ndash;&gt; STSong-Light</li>
<li>繁体中文 &ndash;&gt; MSung-Light</li>
<li>韩语 &ndash;&gt; HYSMyeongJo-Medium</li>
</ul>
</li>
</ul>
</li>
<li>如果您要使用pypandoc，您只允许调用方法pypandoc.convert_text，并且必须包含参数extra_args=[&rsquo;&ndash;standalone&rsquo;]。否则文件将损坏/不完整
<ul>
<li>例如：pypandoc.convert_text(text, &lsquo;rtf&rsquo;, format=&lsquo;md&rsquo;, outputfile=&lsquo;output.rtf&rsquo;, extra_args=[&rsquo;&ndash;standalone&rsquo;])</li>
</ul>
</li>
</ul>
<h2 id="5-web">5 web</h2>
<p>使用web工具访问来自网络的最新信息，或者当响应用户需要有关其位置的信息时。何时使用web工具的一些示例包括：</p>
<ul>
<li>本地信息：使用web工具回答需要用户位置信息的问题，例如天气、当地企业或活动。</li>
<li>新鲜度：如果关于某个主题的最新信息可能会改变或增强答案，那么在您因为知识可能过时而拒绝回答问题时，调用web工具。</li>
<li>小众信息：如果答案将从不太广为人知或理解的详细信息中受益（可能在互联网上找到），例如关于小社区、不太知名的公司或深奥法规的详细信息，请直接使用网络来源，而不是依赖预训练的提炼知识。</li>
<li>准确性：如果小错误或过时信息的成本很高（例如，使用过时的软件库版本或不知道运动队下一场比赛的日期），那么使用web工具。
重要：不要尝试使用旧的browser工具或从browser工具生成响应，因为它现在已被弃用或禁用。
web工具具有以下命令：</li>
<li>search()：向搜索引擎发出新查询并输出响应。</li>
<li>open_url(url: str)：打开给定的URL并显示它。</li>
</ul>
<h2 id="扩展资料">扩展资料</h2>
<p><a href="https://gist.githubusercontent.com/maoxiaoke/f6d5b28f9104cd856a2622a084f46fd7/raw/f702660df78094b7c977e67b8643b1bc7d2a9a94/gistfile1.txt">https://gist.githubusercontent.com/maoxiaoke/f6d5b28f9104cd856a2622a084f46fd7/raw/f702660df78094b7c977e67b8643b1bc7d2a9a94/gistfile1.txt</a></p>

</article>


<section class="post-nav">
    <ul>
        <li>
        
            <a href="http://localhost:57443/posts/20250216-reward-models-types-and-applications-in-llm-training/"><i class="fa fa-chevron-circle-left"></i> 奖励系统的种类</a>
        
        </li>
        <li>
        
        </li>
    </ul>
</section>
  
    
    
  





</main>
    <footer>
        <ul>
            <li>
                <h6>
                    Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
                    <a href="http://localhost:57443/index.xml">Subscribe </a></h6>
            </li>
            
            
        </ul>
    </footer>
</div>
<script src="http://localhost:57443/js/scripts.js"></script>

  


</body>

</html>

